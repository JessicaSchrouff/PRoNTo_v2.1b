<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of prt_ui_disp_weights</title>
  <meta name="keywords" content="prt_ui_disp_weights">
  <meta name="description" content="PRT_UI_DISP_WEIGHTS MATLAB code for prt_ui_disp_weights.fig">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../index.html">Home</a> &gt;  <a href="index.html">.</a> &gt; prt_ui_disp_weights.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../index.html"><img alt="<" border="0" src="../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="index.html">Index for .&nbsp;<img alt=">" border="0" src="../right.png"></a></td></tr></table>-->

<h1>prt_ui_disp_weights
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>PRT_UI_DISP_WEIGHTS MATLAB code for prt_ui_disp_weights.fig</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>function varargout = prt_ui_disp_weights(varargin) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre class="comment"> PRT_UI_DISP_WEIGHTS MATLAB code for prt_ui_disp_weights.fig

 PRT_UI_DISP_WEIGHTS, by itself, creates a new PRT_UI_DISP_WEIGHTS or raises the
 existing singleton*.

 H = PRT_UI_DISP_WEIGHTS returns the handle to a new PRT_UI_DISP_WEIGHTS or the
 handle to the existing singleton*.

 PRT_UI_DISP_WEIGHTS('CALLBACK',hObject,eventData,handles,...) calls the local
 function named CALLBACK in PRT_UI_DISP_WEIGHTS.M with the given input arguments.

 PRT_UI_DISP_WEIGHTS('Property','Value',...) creates a new PRT_UI_DISP_WEIGHTS or
 raises the existing singleton*.  Starting from the left, property value
 pairs are applied to the GUI before prt_ui_disp_weights_OpeningFcn gets called.
 An unrecognized property name or invalid value makes property application
 stop.  All inputs are passed to prt_ui_disp_weights_OpeningFcn via varargin.

 *See GUI Options on GUIDE's Tools menu.  Choose &quot;GUI allows only one
 instance to run (singleton)&quot;.

 See also: GUIDE, GUIDATA, GUIHANDLES
__________________________________________________________________________
 Copyright (C) 2011 Machine Learning &amp; Neuroimaging Laboratory</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="prt_get_defaults.html" class="code" title="function varargout = prt_get_defaults(defstr, varargin)">prt_get_defaults</a>	Get/set the defaults values associated with an identifier</li><li><a href="prt_init_fs.html" class="code" title="function [fid,PRT,tocomp] = prt_init_fs(PRT, in, mids,mask,precmask,headers)">prt_init_fs</a>	function to initialise the kernel data structure</li><li><a href="prt_ui_results.html" class="code" title="function varargout = prt_ui_results(varargin)">prt_ui_results</a>	PRT_UI_RESULTS MATLAB code for prt_ui_results.fig</li></ul>
This function is called by:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="prt_ui_main.html" class="code" title="function varargout = prt_ui_main(varargin)">prt_ui_main</a>	PRT_UI_MAIN M-file for prt_ui_main.fig</li></ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="#_sub1" class="code">function prt_ui_disp_weights_OpeningFcn(hObject, eventdata, handles, varargin)</a></li><li><a href="#_sub2" class="code">function varargout = prt_ui_disp_weights_OutputFcn(hObject, eventdata, handles)</a></li><li><a href="#_sub3" class="code">function originbutton_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub4" class="code">function mmedit_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub5" class="code">function mmedit_CreateFcn(hObject, eventdata, handles)</a></li><li><a href="#_sub6" class="code">function vxedit_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub7" class="code">function vxedit_CreateFcn(hObject, eventdata, handles)</a></li><li><a href="#_sub8" class="code">function quitbutton_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub9" class="code">function loadweight_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub10" class="code">function loadweight_CreateFcn(hObject, eventdata, handles)</a></li><li><a href="#_sub11" class="code">function weightbutton_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub12" class="code">function loadanatomical_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub13" class="code">function loadanatomical_CreateFcn(hObject, eventdata, handles)</a></li><li><a href="#_sub14" class="code">function anatomicalbutton_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub15" class="code">function foldmenu_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub16" class="code">function foldmenu_CreateFcn(hObject, eventdata, handles)</a></li><li><a href="#_sub17" class="code">function classmenu_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub18" class="code">function classmenu_CreateFcn(hObject, eventdata, handles)</a></li><li><a href="#_sub19" class="code">function imagemenu_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub20" class="code">function imagemenu_CreateFcn(hObject, eventdata, handles)</a></li><li><a href="#_sub21" class="code">function repedit_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub22" class="code">function repedit_CreateFcn(hObject, eventdata, handles)</a></li><li><a href="#_sub23" class="code">function showpos()</a></li><li><a href="#_sub24" class="code">function resetbutton_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub25" class="code">function savemenu_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub26" class="code">function disp_weights_CellSelectionCallback(hObject,eventdata,handles)</a></li><li><a href="#_sub27" class="code">function listbox1_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub28" class="code">function listbox1_CreateFcn(hObject, eventdata, handles)</a></li><li><a href="#_sub29" class="code">function butt_load_labels_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub30" class="code">function disp_voxels_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub31" class="code">function disp_regions_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub32" class="code">function ROItable_CellEditCallback(hObject, eventdata, handles)</a></li><li><a href="#_sub33" class="code">function edit7_Callback(hObject, eventdata, handles)</a></li><li><a href="#_sub34" class="code">function edit7_CreateFcn(hObject, eventdata, handles)</a></li><li><a href="#_sub35" class="code">function saveweight_Callback(hObject, eventdata, handles)</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function varargout = prt_ui_disp_weights(varargin)</a>
0002 <span class="comment">% PRT_UI_DISP_WEIGHTS MATLAB code for prt_ui_disp_weights.fig</span>
0003 <span class="comment">%</span>
0004 <span class="comment">% PRT_UI_DISP_WEIGHTS, by itself, creates a new PRT_UI_DISP_WEIGHTS or raises the</span>
0005 <span class="comment">% existing singleton*.</span>
0006 <span class="comment">%</span>
0007 <span class="comment">% H = PRT_UI_DISP_WEIGHTS returns the handle to a new PRT_UI_DISP_WEIGHTS or the</span>
0008 <span class="comment">% handle to the existing singleton*.</span>
0009 <span class="comment">%</span>
0010 <span class="comment">% PRT_UI_DISP_WEIGHTS('CALLBACK',hObject,eventData,handles,...) calls the local</span>
0011 <span class="comment">% function named CALLBACK in PRT_UI_DISP_WEIGHTS.M with the given input arguments.</span>
0012 <span class="comment">%</span>
0013 <span class="comment">% PRT_UI_DISP_WEIGHTS('Property','Value',...) creates a new PRT_UI_DISP_WEIGHTS or</span>
0014 <span class="comment">% raises the existing singleton*.  Starting from the left, property value</span>
0015 <span class="comment">% pairs are applied to the GUI before prt_ui_disp_weights_OpeningFcn gets called.</span>
0016 <span class="comment">% An unrecognized property name or invalid value makes property application</span>
0017 <span class="comment">% stop.  All inputs are passed to prt_ui_disp_weights_OpeningFcn via varargin.</span>
0018 <span class="comment">%</span>
0019 <span class="comment">% *See GUI Options on GUIDE's Tools menu.  Choose &quot;GUI allows only one</span>
0020 <span class="comment">% instance to run (singleton)&quot;.</span>
0021 <span class="comment">%</span>
0022 <span class="comment">% See also: GUIDE, GUIDATA, GUIHANDLES</span>
0023 <span class="comment">%__________________________________________________________________________</span>
0024 <span class="comment">% Copyright (C) 2011 Machine Learning &amp; Neuroimaging Laboratory</span>
0025 
0026 <span class="comment">% Written by M. J. Rosa and J. Schrouff</span>
0027 <span class="comment">% $Id: prt_ui_disp_weights.m 784 2013-08-22 16:43:32Z monteiro $</span>
0028 
0029 <span class="comment">% Edit the above text to modify the response to help prt_ui_disp_weights</span>
0030 
0031 <span class="comment">% Last Modified by GUIDE v2.5 16-Apr-2014 17:50:09</span>
0032 
0033 <span class="comment">% Begin initialization code - DO NOT EDIT</span>
0034 gui_Singleton = 1;
0035 gui_State = struct(<span class="string">'gui_Name'</span>,       mfilename, <span class="keyword">...</span>
0036     <span class="string">'gui_Singleton'</span>,  gui_Singleton, <span class="keyword">...</span>
0037     <span class="string">'gui_OpeningFcn'</span>, @<a href="#_sub1" class="code" title="subfunction prt_ui_disp_weights_OpeningFcn(hObject, eventdata, handles, varargin)">prt_ui_disp_weights_OpeningFcn</a>, <span class="keyword">...</span>
0038     <span class="string">'gui_OutputFcn'</span>,  @<a href="#_sub2" class="code" title="subfunction varargout = prt_ui_disp_weights_OutputFcn(hObject, eventdata, handles)">prt_ui_disp_weights_OutputFcn</a>, <span class="keyword">...</span>
0039     <span class="string">'gui_LayoutFcn'</span>,  [] , <span class="keyword">...</span>
0040     <span class="string">'gui_Callback'</span>,   []);
0041 <span class="keyword">if</span> nargin &amp;&amp; ischar(varargin{1})
0042     gui_State.gui_Callback = str2func(varargin{1});
0043 <span class="keyword">end</span>
0044 
0045 <span class="keyword">if</span> nargout
0046     [varargout{1:nargout}] = gui_mainfcn(gui_State, varargin{:});
0047 <span class="keyword">else</span>
0048     gui_mainfcn(gui_State, varargin{:});
0049 <span class="keyword">end</span>
0050 <span class="comment">% End initialization code - DO NOT EDIT</span>
0051 
0052 
0053 <span class="comment">% --- Executes just before prt_ui_disp_weights is made visible.</span>
0054 <a name="_sub1" href="#_subfunctions" class="code">function prt_ui_disp_weights_OpeningFcn(hObject, eventdata, handles, varargin)</a>
0055 <span class="comment">% This function has no output args, see OutputFcn.</span>
0056 <span class="comment">% hObject    handle to figure</span>
0057 <span class="comment">% eventdata  reserved - to be defined in a future version of MATLAB</span>
0058 <span class="comment">% handles    structure with handles and user data (see GUIDATA)</span>
0059 <span class="comment">% varargin   command line arguments to prt_ui_disp_weights (see VARARGIN)</span>
0060 
0061 <span class="comment">%if window already exists, just put it as the current figure</span>
0062 Tag=<span class="string">'WeightResults'</span>;
0063 F = findall(allchild(0),<span class="string">'Flat'</span>,<span class="string">'Tag'</span>,Tag);
0064 <span class="keyword">if</span> length(F) &gt; 1
0065     <span class="comment">% Multiple Graphics windows - close all but most recent</span>
0066     close(F(2:end))
0067     F = F(1);
0068     uistack(F,<span class="string">'top'</span>)
0069 <span class="keyword">elseif</span> length(F)==1
0070     uistack(F,<span class="string">'top'</span>)
0071 <span class="keyword">else</span>
0072     set(handles.figure1,<span class="string">'Tag'</span>,Tag)
0073     set(handles.figure1,<span class="string">'Name'</span>,<span class="string">'PRoNTo :: Model interpretation'</span>)
0074     set(handles.figure1,<span class="string">'MenuBar'</span>,<span class="string">'figure'</span>,<span class="string">'WindowStyle'</span>,<span class="string">'normal'</span>);
0075     
0076     <span class="comment">%set size of the window, taking screen resolution and platform into account</span>
0077     <span class="comment">%--------------------------------------------------------------------------</span>
0078     S0= spm(<span class="string">'WinSize'</span>,<span class="string">'0'</span>,1);   <span class="comment">%-Screen size (of the current monitor)</span>
0079     <span class="keyword">if</span> ispc
0080         PF=<span class="string">'MS Sans Serif'</span>;
0081     <span class="keyword">else</span>
0082         PF= spm_platform(<span class="string">'fonts'</span>);     <span class="comment">%-Font names (for this platform)</span>
0083         PF=PF.helvetica;
0084     <span class="keyword">end</span>
0085     tmp  = [S0(3)/1280 (S0(4))/800];
0086     ratio=min(tmp)*[1 1 1 1];
0087     FS = 1 + 0.85*(min(ratio)-1);  <span class="comment">%factor to scale the fonts</span>
0088     x=get(handles.figure1,<span class="string">'Position'</span>);
0089     set(handles.figure1,<span class="string">'Position'</span>,ratio.*x)
0090     set(handles.figure1,<span class="string">'Resize'</span>,<span class="string">'on'</span>)
0091     
0092     
0093     color=<a href="prt_get_defaults.html" class="code" title="function varargout = prt_get_defaults(defstr, varargin)">prt_get_defaults</a>(<span class="string">'color'</span>);
0094     set(handles.figure1,<span class="string">'Color'</span>,color.bg1)
0095     aa=get(handles.figure1,<span class="string">'children'</span>);
0096     <span class="keyword">for</span> i=1:length(aa)
0097         <span class="keyword">if</span> strcmpi(get(aa(i),<span class="string">'type'</span>),<span class="string">'uipanel'</span>)
0098             set(aa(i),<span class="string">'BackgroundColor'</span>,color.bg2)
0099             bb=get(aa(i),<span class="string">'children'</span>);
0100             <span class="keyword">if</span> ~isempty(bb)
0101                 <span class="keyword">for</span> j=1:length(bb)
0102                     <span class="keyword">if</span> strcmpi(get(bb(j),<span class="string">'type'</span>),<span class="string">'uipanel'</span>)
0103                         cc=get(bb(j),<span class="string">'children'</span>);
0104                         set(bb(j),<span class="string">'BackgroundColor'</span>,color.bg2)
0105                         <span class="keyword">for</span> k=1:length(cc)
0106                             <span class="keyword">if</span> strcmpi(get(cc(k),<span class="string">'type'</span>),<span class="string">'uipanel'</span>)
0107                                 dd=get(cc(k),<span class="string">'children'</span>);
0108                                 set(cc(k),<span class="string">'BackgroundColor'</span>,color.bg2)
0109                                 <span class="keyword">for</span> l=1:length(dd)
0110                                     <span class="keyword">if</span> strcmpi(get(dd(l),<span class="string">'type'</span>),<span class="string">'uicontrol'</span>)
0111                                         <span class="keyword">if</span> ~isempty(find(strcmpi(get(dd(l),<span class="string">'Style'</span>),{<span class="string">'text'</span>,<span class="keyword">...</span>
0112                                                 <span class="string">'radiobutton'</span>,<span class="string">'checkbox'</span>})))
0113                                             set(dd(l),<span class="string">'BackgroundColor'</span>,color.bg2)
0114                                         <span class="keyword">elseif</span> ~isempty(find(strcmpi(get(dd(l),<span class="string">'Style'</span>),<span class="string">'pushbutton'</span>)))
0115                                             set(dd(l),<span class="string">'BackgroundColor'</span>,color.fr)
0116                                         <span class="keyword">end</span>
0117                                     <span class="keyword">end</span>
0118                                     set(dd(l),<span class="string">'FontUnits'</span>,<span class="string">'pixel'</span>)
0119                                     xf=get(dd(l),<span class="string">'FontSize'</span>);
0120                                     <span class="keyword">if</span> ispc
0121                                         set(dd(l),<span class="string">'FontSize'</span>,ceil(FS*xf),<span class="string">'FontName'</span>,PF,<span class="keyword">...</span>
0122                                             <span class="string">'FontUnits'</span>,<span class="string">'normalized'</span>,<span class="string">'Units'</span>,<span class="string">'normalized'</span>)
0123                                     <span class="keyword">else</span>
0124                                         set(dd(l),<span class="string">'FontSize'</span>,ceil(FS*xf),<span class="string">'FontName'</span>,PF,<span class="keyword">...</span>
0125                                             <span class="string">'Units'</span>,<span class="string">'normalized'</span>)
0126                                     <span class="keyword">end</span>
0127                                 <span class="keyword">end</span>
0128                             <span class="keyword">elseif</span> strcmpi(get(cc(k),<span class="string">'type'</span>),<span class="string">'uicontrol'</span>) &amp;&amp; <span class="keyword">...</span>
0129                                     ~isempty(find(strcmpi(get(cc(k),<span class="string">'Style'</span>),{<span class="string">'text'</span>,<span class="keyword">...</span>
0130                                     <span class="string">'radiobutton'</span>,<span class="string">'checkbox'</span>})))
0131                                 set(cc(k),<span class="string">'BackgroundColor'</span>,color.bg2)
0132                             <span class="keyword">elseif</span> strcmpi(get(cc(k),<span class="string">'type'</span>),<span class="string">'uicontrol'</span>)&amp;&amp; <span class="keyword">...</span>
0133                                     ~isempty(find(strcmpi(get(cc(k),<span class="string">'Style'</span>),<span class="string">'pushbutton'</span>)))
0134                                 set(cc(k),<span class="string">'BackgroundColor'</span>,color.fr)
0135                             <span class="keyword">end</span>
0136                             set(cc(k),<span class="string">'FontUnits'</span>,<span class="string">'pixel'</span>)
0137                             xf=get(cc(k),<span class="string">'FontSize'</span>);
0138                             set(cc(k),<span class="string">'FontSize'</span>,ceil(FS*xf),<span class="string">'FontName'</span>,PF,<span class="keyword">...</span>
0139                                 <span class="string">'Units'</span>,<span class="string">'normalized'</span>)
0140                         <span class="keyword">end</span>
0141                     <span class="keyword">elseif</span> strcmpi(get(bb(j),<span class="string">'type'</span>),<span class="string">'uicontrol'</span>) &amp;&amp; <span class="keyword">...</span>
0142                             ~isempty(find(strcmpi(get(bb(j),<span class="string">'Style'</span>),{<span class="string">'text'</span>,<span class="keyword">...</span>
0143                             <span class="string">'radiobutton'</span>,<span class="string">'checkbox'</span>})))
0144                         set(bb(j),<span class="string">'BackgroundColor'</span>,color.bg2)
0145                     <span class="keyword">elseif</span> strcmpi(get(bb(j),<span class="string">'type'</span>),<span class="string">'uicontrol'</span>) &amp;&amp; <span class="keyword">...</span>
0146                             ~isempty(find(strcmpi(get(bb(j),<span class="string">'Style'</span>),<span class="string">'pushbutton'</span>)))
0147                         set(bb(j),<span class="string">'BackgroundColor'</span>,color.fr)
0148                     <span class="keyword">end</span>
0149                     set(bb(j),<span class="string">'FontUnits'</span>,<span class="string">'pixel'</span>)
0150                     xf=get(bb(j),<span class="string">'FontSize'</span>);
0151                     set(bb(j),<span class="string">'FontSize'</span>,ceil(FS*xf),<span class="string">'FontName'</span>,PF,<span class="keyword">...</span>
0152                         <span class="string">'Units'</span>,<span class="string">'normalized'</span>)
0153                 <span class="keyword">end</span>
0154             <span class="keyword">end</span>
0155         <span class="keyword">elseif</span> strcmpi(get(aa(i),<span class="string">'type'</span>),<span class="string">'uicontrol'</span>)
0156             <span class="keyword">if</span> ~isempty(find(strcmpi(get(aa(i),<span class="string">'Style'</span>),{<span class="string">'text'</span>,<span class="keyword">...</span>
0157                     <span class="string">'radiobutton'</span>,<span class="string">'checkbox'</span>})))
0158                 set(aa(i),<span class="string">'BackgroundColor'</span>,color.bg1)
0159             <span class="keyword">elseif</span> ~isempty(find(strcmpi(get(aa(i),<span class="string">'Style'</span>),<span class="string">'pushbutton'</span>)))
0160                 set(aa(i),<span class="string">'BackgroundColor'</span>,color.fr)
0161             <span class="keyword">end</span>
0162         <span class="keyword">end</span>
0163         <span class="keyword">if</span> ~strcmpi(get(aa(i),<span class="string">'type'</span>),<span class="string">'uimenu'</span>)
0164             set(aa(i),<span class="string">'FontUnits'</span>,<span class="string">'pixel'</span>)
0165             xf=get(aa(i),<span class="string">'FontSize'</span>);
0166             set(aa(i),<span class="string">'FontSize'</span>,ceil(FS*xf),<span class="string">'FontName'</span>,PF,<span class="keyword">...</span>
0167                 <span class="string">'Units'</span>,<span class="string">'normalized'</span>)
0168         <span class="keyword">end</span>
0169     <span class="keyword">end</span>
0170     
0171     
0172     <span class="comment">% Initialize window</span>
0173     <span class="comment">% -------------------------------------------------------------------------</span>
0174     
0175     <span class="keyword">if</span> ~isfield(handles,<span class="string">'notinit'</span>)
0176         
0177         <span class="comment">% Load PRT.mat</span>
0178         PRT     = spm_select(1,<span class="string">'mat'</span>,<span class="string">'Select PRT.mat'</span>,[],pwd,<span class="string">'PRT.mat'</span>);
0179         <span class="keyword">if</span> isempty(PRT)
0180             error(<span class="string">'prt_ui_disp_weights:NoPRT'</span>,<span class="string">'No PRT file selected'</span>)        
0181         <span class="keyword">end</span>
0182 
0183         pathdir = regexprep(PRT,<span class="string">'PRT.mat'</span>, <span class="string">''</span>);
0184         handles.pathdir = pathdir;
0185         handles.prtdir=fileparts(PRT);
0186         load(PRT);
0187         
0188         <span class="comment">% Save PRT</span>
0189         handles.PRT = PRT;
0190         
0191         <span class="comment">% Flag to load new weights</span>
0192         handles.noloadw = 0;
0193         
0194         <span class="comment">% Load model names</span>
0195         <span class="keyword">if</span> ~isfield(PRT,<span class="string">'model'</span>)
0196             error(<span class="string">'No models found in PRT.mat!'</span>)
0197         <span class="keyword">end</span>
0198         
0199         
0200         nmodels = length(PRT.model);
0201         mi  = [];
0202         nmi = 0;
0203         nmroi = 0;
0204         <span class="keyword">for</span> m = 1:nmodels
0205             <span class="keyword">if</span> isfield(PRT.model(m),<span class="string">'input'</span>) &amp;&amp; ~isempty(PRT.model(m).input)
0206                 <span class="keyword">if</span> isfield(PRT.model(m),<span class="string">'output'</span>) &amp;&amp; ~isempty(PRT.model(m).output)
0207                     <span class="keyword">if</span> isfield(PRT.model(m).output,<span class="string">'weight_img'</span>) &amp;&amp; ~isempty(PRT.model(m).output.weight_img)
0208                         nmi = nmi +1;
0209                         model_name{nmi} = PRT.model(m).model_name;
0210                         mi = [mi, m];
0211                         <span class="keyword">if</span> isfield(PRT.model(m).output,<span class="string">'weight_ROI'</span>) &amp;&amp; <span class="keyword">...</span>
0212                                 ~isempty(PRT.model(m).output.weight_ROI)
0213                             nmroi = nmroi+1;
0214                         <span class="keyword">end</span>
0215                     <span class="keyword">else</span>
0216                         disp(sprintf(<span class="string">'Weights not computed for model %s ! It will not be displayed'</span>,PRT.model(m).model_name));
0217                     <span class="keyword">end</span>
0218                 <span class="keyword">else</span>
0219                     beep;
0220                     disp(sprintf(<span class="string">'Weights not computed for model %s ! It will not be displayed'</span>,PRT.model(m).model_name));
0221                 <span class="keyword">end</span>
0222             <span class="keyword">else</span>
0223                 beep;
0224                 disp(sprintf(<span class="string">'Model %s not properly specified! It will not be displayed'</span>,PRT.model(m).model_name));
0225             <span class="keyword">end</span>
0226             
0227         <span class="keyword">end</span>
0228         <span class="comment">%         if ~nmi, error('There are no estimated/good models in this</span>
0229         <span class="comment">%         PRT!'); end</span>
0230         
0231         <span class="keyword">if</span> nmi
0232             handles.mi = mi;
0233             
0234             <span class="comment">% Set model pulldown menu</span>
0235             handles.mnames = model_name;
0236             set(handles.classmenu,<span class="string">'String'</span>,handles.mnames);
0237             
0238             <span class="comment">% Get folds pulldown menu</span>
0239             m             = get(handles.classmenu,<span class="string">'Value'</span>);
0240             handles.nfold = length(PRT.model(mi(m)).output.fold);
0241             folds{1}      = <span class="string">'All folds / Average'</span>;
0242             <span class="keyword">for</span> f = 1:handles.nfold
0243                 folds{f+1} = num2str(f);
0244             <span class="keyword">end</span>
0245             handles.folds = folds;
0246             set(handles.foldmenu,<span class="string">'String'</span>,handles.folds);
0247             set(handles.foldmenu,<span class="string">'Value'</span>,1);
0248             
0249             list = handles.PRT.model(mi(m)).output.weight_img;
0250             <span class="keyword">if</span> ~isempty(list)
0251                 set(handles.imagemenu,<span class="string">'String'</span>,list)
0252                 set(handles.imagemenu,<span class="string">'Value'</span>,1)
0253             <span class="keyword">else</span>
0254                 set(handles.imagemenu,<span class="string">'Enable'</span>,<span class="string">'off'</span>)
0255             <span class="keyword">end</span>
0256             
0257             
0258         <span class="keyword">end</span>
0259         <span class="comment">% Initialize model button</span>
0260         handles.model_button = 0;
0261         
0262         <span class="comment">% Deal with ROI table and bar graph: 1st turned off</span>
0263         set(handles.axes1, <span class="string">'visible'</span>,<span class="string">'off'</span>)
0264         set(handles.ROItable,<span class="string">'visible'</span>,<span class="string">'off'</span>)
0265         handles.selectedcell = [];
0266         handles.labels=cell(nmodels,1);
0267         set(handles.butt_load_labels,<span class="string">'visible'</span>,<span class="string">'off'</span>);
0268         set(handles.saveweight,<span class="string">'visible'</span>,<span class="string">'off'</span>);
0269         set(handles.modtable,<span class="string">'Visible'</span>,<span class="string">'off'</span>)
0270         set(handles.modtable,<span class="string">'Enable'</span>,<span class="string">'off'</span>)
0271         <span class="comment">% Clear axes</span>
0272         cla(handles.axes1);
0273     <span class="keyword">end</span>
0274 <span class="keyword">end</span>
0275 set(handles.disp_voxels,<span class="string">'Value'</span>,1)
0276 set(handles.disp_voxels,<span class="string">'Enable'</span>,<span class="string">'off'</span>)
0277 set(handles.disp_regions,<span class="string">'Value'</span>,0)
0278 set(handles.disp_regions,<span class="string">'Enable'</span>,<span class="string">'off'</span>)
0279 <span class="comment">% Choose default command line output for prt_ui_disp_weights</span>
0280 handles.output = hObject;
0281 
0282 <span class="comment">% Update handles structure</span>
0283 guidata(hObject, handles);
0284 
0285 <span class="comment">% UIWAIT makes prt_ui_disp_weights wait for user response (see UIRESUME)</span>
0286 <span class="comment">% uiwait(handles.figure1);</span>
0287 
0288 
0289 <span class="comment">% --- Outputs from this function are returned to the command line.</span>
0290 <a name="_sub2" href="#_subfunctions" class="code">function varargout = prt_ui_disp_weights_OutputFcn(hObject, eventdata, handles)</a>
0291 <span class="comment">% varargout  cell array for returning output args (see VARARGOUT);</span>
0292 <span class="comment">% hObject    handle to figure</span>
0293 <span class="comment">% eventdata  reserved - to be defined in a future version of MATLAB</span>
0294 <span class="comment">% handles    structure with handles and user data (see GUIDATA)</span>
0295 
0296 <span class="comment">% Get default command line output from handles structure</span>
0297 varargout{1} = handles.output;
0298 
0299 
0300 <span class="comment">% --- Executes on button press in originbutton.</span>
0301 <a name="_sub3" href="#_subfunctions" class="code">function originbutton_Callback(hObject, eventdata, handles)</a>
0302 <span class="comment">% hObject    handle to originbutton (see GCBO)</span>
0303 <span class="comment">% eventdata  reserved - to be defined in a future version of MATLAB</span>
0304 <span class="comment">% handles    structure with handles and user data (see GUIDATA)</span>
0305 
0306 <span class="comment">% Reset the crosshairs position</span>
0307 <span class="comment">% -------------------------------------------------------------------------</span>
0308 <span class="keyword">if</span> isfield(handles,<span class="string">'img'</span>)
0309     spm_orthviews(<span class="string">'Reposition'</span>,[0 0 0]);
0310 <span class="keyword">end</span>
0311 
0312 <a name="_sub4" href="#_subfunctions" class="code">function mmedit_Callback(hObject, eventdata, handles)</a>
0313 <span class="comment">% hObject    handle to mmedit (see GCBO)</span>
0314 <span class="comment">% eventdata  reserved - to be defined in a future version of MATLAB</span>
0315 <span class="comment">% handles    structure with handles and user data (see GUIDATA)</span>
0316 
0317 <span class="comment">% Hints: get(hObject,'String') returns contents of mmedit as text</span>
0318 <span class="comment">%        str2double(get(hObject,'String')) returns contents of mmedit as a double</span>
0319 
0320 <span class="comment">% Move crosshairs position in mm</span>
0321 <span class="comment">% -------------------------------------------------------------------------</span>
0322 <span class="keyword">if</span> isfield(handles,<span class="string">'img'</span>)
0323     mp    = handles.mmedit;
0324     posmm = get(mp,<span class="string">'String'</span>);
0325     pos = sscanf(posmm, <span class="string">'%g %g %g'</span>);
0326     <span class="keyword">if</span> length(pos)~=3
0327         pos = spm_orthviews(<span class="string">'Pos'</span>);
0328     <span class="keyword">end</span>
0329     spm_orthviews(<span class="string">'Reposition'</span>,pos);
0330 <span class="keyword">end</span>
0331 
0332 <span class="comment">% --- Executes during object creation, after setting all properties.</span>
0333 <a name="_sub5" href="#_subfunctions" class="code">function mmedit_CreateFcn(hObject, eventdata, handles)</a>
0334 <span class="comment">% hObject    handle to mmedit (see GCBO)</span>
0335 <span class="comment">% eventdata  reserved - to be defined in a future version of MATLAB</span>
0336 <span class="comment">% handles    empty - handles not created until after all CreateFcns called</span>
0337 
0338 <span class="comment">% Hint: edit controls usually have a white background on Windows.</span>
0339 <span class="comment">%       See ISPC and COMPUTER.</span>
0340 <span class="keyword">if</span> ispc &amp;&amp; isequal(get(hObject,<span class="string">'BackgroundColor'</span>), get(0,<span class="string">'defaultUicontrolBackgroundColor'</span>))
0341     set(hObject,<span class="string">'BackgroundColor'</span>,<span class="string">'white'</span>);
0342 <span class="keyword">end</span>
0343 
0344 
0345 <a name="_sub6" href="#_subfunctions" class="code">function vxedit_Callback(hObject, eventdata, handles)</a>
0346 <span class="comment">% hObject    handle to vxedit (see GCBO)</span>
0347 <span class="comment">% eventdata  reserved - to be defined in a future version of MATLAB</span>
0348 <span class="comment">% handles    structure with handles and user data (see GUIDATA)</span>
0349 
0350 <span class="comment">% Hints: get(hObject,'String') returns contents of vxedit as text</span>
0351 <span class="comment">%        str2double(get(hObject,'String')) returns contents of vxedit as a double</span>
0352 
0353 <span class="comment">% Move crosshairs position in vx</span>
0354 <span class="comment">% -------------------------------------------------------------------------</span>
0355 <span class="keyword">if</span> isfield(handles,<span class="string">'img'</span>)
0356     mp    = handles.vxedit;
0357     posvx = get(mp,<span class="string">'String'</span>);
0358     pos   = sscanf(posvx, <span class="string">'%g %g %g'</span>);
0359     <span class="keyword">if</span> length(pos)~=3
0360         pos = spm_orthviews(<span class="string">'pos'</span>,1);
0361     <span class="keyword">end</span>
0362     tmp = handles.vols{1}.mat;
0363     pos = tmp(1:3,:)*[pos ; 1];
0364     spm_orthviews(<span class="string">'Reposition'</span>,pos);
0365 <span class="keyword">end</span>
0366 
0367 
0368 <span class="comment">% --- Executes during object creation, after setting all properties.</span>
0369 <a name="_sub7" href="#_subfunctions" class="code">function vxedit_CreateFcn(hObject, eventdata, handles)</a>
0370 <span class="comment">% hObject    handle to vxedit (see GCBO)</span>
0371 <span class="comment">% eventdata  reserved - to be defined in a future version of MATLAB</span>
0372 <span class="comment">% handles    empty - handles not created until after all CreateFcns called</span>
0373 
0374 <span class="comment">% Hint: edit controls usually have a white background on Windows.</span>
0375 <span class="comment">%       See ISPC and COMPUTER.</span>
0376 <span class="keyword">if</span> ispc &amp;&amp; isequal(get(hObject,<span class="string">'BackgroundColor'</span>), get(0,<span class="string">'defaultUicontrolBackgroundColor'</span>))
0377     set(hObject,<span class="string">'BackgroundColor'</span>,<span class="string">'white'</span>);
0378 <span class="keyword">end</span>
0379 
0380 
0381 <span class="comment">% --- Executes on button press in quitbutton.</span>
0382 <a name="_sub8" href="#_subfunctions" class="code">function quitbutton_Callback(hObject, eventdata, handles)</a>
0383 <span class="comment">% hObject    handle to quitbutton (see GCBO)</span>
0384 <span class="comment">% eventdata  reserved - to be defined in a future version of MATLAB</span>
0385 <span class="comment">% handles    structure with handles and user data (see GUIDATA)</span>
0386 
0387 <span class="comment">% Close and clear figure</span>
0388 <span class="comment">% -------------------------------------------------------------------------</span>
0389 close(handles.figure1);
0390 
0391 
0392 <a name="_sub9" href="#_subfunctions" class="code">function loadweight_Callback(hObject, eventdata, handles)</a>
0393 <span class="comment">% hObject    handle to loadweight (see GCBO)</span>
0394 <span class="comment">% eventdata  reserved - to be defined in a future version of MATLAB</span>
0395 <span class="comment">% handles    structure with handles and user data (see GUIDATA)</span>
0396 
0397 <span class="comment">% Hints: get(hObject,'String') returns contents of loadweight as text</span>
0398 <span class="comment">%        str2double(get(hObject,'String')) returns contents of loadweight as a double</span>
0399 
0400 
0401 <span class="comment">% --- Executes during object creation, after setting all properties.</span>
0402 <a name="_sub10" href="#_subfunctions" class="code">function loadweight_CreateFcn(hObject, eventdata, handles)</a>
0403 <span class="comment">% hObject    handle to loadweight (see GCBO)</span>
0404 <span class="comment">% eventdata  reserved - to be defined in a future version of MATLAB</span>
0405 <span class="comment">% handles    empty - handles not created until after all CreateFcns called</span>
0406 
0407 <span class="comment">% Hint: edit controls usually have a white background on Windows.</span>
0408 <span class="comment">%       See ISPC and COMPUTER.</span>
0409 <span class="keyword">if</span> ispc &amp;&amp; isequal(get(hObject,<span class="string">'BackgroundColor'</span>), get(0,<span class="string">'defaultUicontrolBackgroundColor'</span>))
0410     set(hObject,<span class="string">'BackgroundColor'</span>,<span class="string">'white'</span>);
0411 <span class="keyword">end</span>
0412 
0413 
0414 <span class="comment">% --- Executes on button press in weightbutton.</span>
0415 <a name="_sub11" href="#_subfunctions" class="code">function weightbutton_Callback(hObject, eventdata, handles)</a>
0416 <span class="comment">% hObject    handle to weightbutton (see GCBO)</span>
0417 <span class="comment">% eventdata  reserved - to be defined in a future version of MATLAB</span>
0418 <span class="comment">% handles    structure with handles and user data (see GUIDATA)</span>
0419 
0420 disp(<span class="string">'Loading weights...&gt;&gt;'</span>)
0421 <span class="comment">% Select results (.img) for weight map</span>
0422 <span class="comment">% -------------------------------------------------------------------------</span>
0423 <span class="keyword">if</span> ~isfield(handles,<span class="string">'wmap'</span>) || ~handles.noloadw
0424     wmap            = spm_select(1,<span class="string">'image'</span>,<span class="string">'Select weight map.'</span>);
0425     <span class="comment">% Remove number in file name</span>
0426     <span class="keyword">if</span> strcmp(wmap(end-1),<span class="string">','</span>)
0427         wmap = wmap(1:end-2);
0428     <span class="keyword">end</span>
0429     V               = spm_vol(wmap);
0430     handles.vols{1} = V;
0431     handles.wmap    = wmap;
0432     
0433 <span class="keyword">end</span>
0434 
0435 spm_orthviews(<span class="string">'Reset'</span>);
0436 gcfchil = get(gcf,<span class="string">'Children'</span>);
0437 <span class="keyword">for</span> i=1:length(gcfchil)
0438     <span class="keyword">if</span> strcmpi(get(gcfchil(i),<span class="string">'Type'</span>),<span class="string">'axes'</span>)
0439         delete(gcfchil(i)) <span class="comment">% Delete any left-over colorbar</span>
0440     <span class="keyword">end</span>
0441 <span class="keyword">end</span>
0442 
0443 <span class="comment">% Image dimensions</span>
0444 <span class="comment">% -------------------------------------------------------------------------</span>
0445 fold          = get(handles.foldmenu,<span class="string">'Value'</span>)-1;
0446 Vfolds        = handles.vols{1};
0447 V             = Vfolds(1);
0448 M             = V.mat;
0449 DIM           = V.dim(1:3)';
0450 xdim          = DIM(1); ydim  = DIM(2); zdim  = DIM(3);
0451 <span class="keyword">if</span> length(V.private.dat.dim) &lt; 4
0452     fdim = 1;                       <span class="comment">% Handle 3D images</span>
0453 <span class="keyword">else</span>
0454     fdim = V.private.dat.dim(4);    <span class="comment">% Handle 4D images</span>
0455 <span class="keyword">end</span>
0456 [xords,yords] = ndgrid(1:xdim,1:ydim);
0457 xords         = xords(:)';  yords = yords(:)';
0458 I             = 1:xdim*ydim;
0459 zords_init    = ones(1,xdim*ydim);
0460 
0461 <span class="keyword">if</span> ~isempty(handles.selectedcell)
0462     matroi = NaN * ones(xdim,ydim,zdim);
0463     idroi = handles.idfeat_roi{handles.sort_roi(handles.selectedcell(1))};
0464     matroi(idroi) = 1;
0465     handles.roimatdisp = matroi;
0466 <span class="keyword">else</span>
0467     matroi = ones(xdim,ydim,zdim);
0468     handles.roimatdisp = matroi;
0469 <span class="keyword">end</span>
0470 
0471 <span class="comment">% Get image values above zero for each fold and all folds</span>
0472 <span class="comment">% -------------------------------------------------------------------------</span>
0473 xyz_above = [];
0474 z_above   = [];
0475 <span class="keyword">if</span> fold == 0,
0476     fold_coord = fdim*ones(1,xdim*ydim);
0477     V = Vfolds(fdim);
0478 <span class="keyword">else</span>
0479     fold_coord = fold*ones(1,xdim*ydim);
0480     V = Vfolds(fold);
0481 <span class="keyword">end</span>
0482 
0483 <span class="keyword">for</span> z = 1:zdim,
0484     zords = z*zords_init;
0485     xyz   = [xords(I); yords(I); zords(I); fold_coord];
0486     zvals = spm_get_data(V,xyz);
0487     <span class="keyword">if</span> isfield(handles,<span class="string">'roimatdisp'</span>) &amp;&amp; ~isempty(handles.roimatdisp)
0488         indmask = sub2ind([xdim,ydim,zdim],xords(I)', yords(I)', zords(I)');
0489         mroi = handles.roimatdisp(indmask);
0490         zvals = zvals.*mroi';
0491     <span class="keyword">end</span>
0492     above = find(~isnan(zvals));
0493     <span class="keyword">if</span> length(above)==length(zvals) <span class="comment">%old version of weight computation</span>
0494         above = find(zvals~=0);
0495     <span class="keyword">end</span>
0496     <span class="keyword">if</span> ~isempty(above)
0497         xyz_above = [xyz_above,xyz(:,above)];
0498         z_above   = [z_above,zvals(above)];
0499     <span class="keyword">end</span>
0500 <span class="keyword">end</span>
0501 XYZ   = xyz_above(1:3,:);
0502 Z     = z_above;
0503 
0504 <span class="comment">%compute center of gravity to reposition crosshairs</span>
0505 xm = round(median(XYZ(1,:)));
0506 ym = round(median(XYZ(2,:)));
0507 zm = round(median(XYZ(3,:)));
0508 <span class="comment">% xmin = min(XYZ(1,:));</span>
0509 <span class="comment">% xmax = max(XYZ(1,:));</span>
0510 <span class="comment">% xfov =xmax-xmin;</span>
0511 <span class="comment">% Set spm_orthviews properties</span>
0512 <span class="comment">% -------------------------------------------------------------------------</span>
0513 rotate3d off
0514 <span class="keyword">global</span> st
0515 
0516 handles.notinit = 1;
0517 handles.img     = 1;
0518 
0519 st.handles  = handles;
0520 st.fig      = handles.figure1;
0521 st.V        = V;
0522 st.callback = <span class="string">'prt_ui_results(''showpos'')'</span>;
0523 
0524 <span class="comment">% Display maps</span>
0525 <span class="comment">% -------------------------------------------------------------------------</span>
0526 [BB vx] = spm_get_bbox(handles.wmap);
0527 xax = BB(1,1):abs(vx(1)):BB(2,1);
0528 yax = BB(1,2):abs(vx(2)):BB(2,2);
0529 zax = BB(1,3):abs(vx(3)):BB(2,3);
0530 
0531 h  = spm_orthviews(<span class="string">'Image'</span>, handles.wmap,[0.0519 0.498 0.4182 0.3951]);
0532 handles.wimgh = h;
0533 spm_orthviews(<span class="string">'AddContext'</span>, h);
0534 spm_orthviews(<span class="string">'MaxBB'</span>);
0535 spm_orthviews(<span class="string">'AddBlobs'</span>, h, XYZ, Z, M);
0536 cmap = get(gcf,<span class="string">'Colormap'</span>);
0537 <span class="keyword">if</span> size(cmap,1)~=128
0538     spm_figure(<span class="string">'Colormap'</span>,<span class="string">'jet'</span>);
0539 <span class="keyword">end</span>
0540 spm_orthviews(<span class="string">'Reposition'</span>,[sign(vx(1))*xax(xm),sign(vx(2))*yax(ym),sign(vx(3))*zax(zm)])
0541 <span class="comment">% spm_orthviews('Zoom',(xfov*abs(vx(1))))</span>
0542 spm_orthviews(<span class="string">'Redraw'</span>);
0543 
0544 <span class="keyword">if</span> isfield(handles,<span class="string">'aimg'</span>)
0545     <a href="#_sub14" class="code" title="subfunction anatomicalbutton_Callback(hObject, eventdata, handles)">anatomicalbutton_Callback</a>(hObject, eventdata, handles);
0546 <span class="keyword">end</span>
0547 
0548 <span class="comment">% Show positions</span>
0549 <span class="comment">% -------------------------------------------------------------------------</span>
0550 <a href="prt_ui_results.html" class="code" title="function varargout = prt_ui_results(varargin)">prt_ui_results</a>(<span class="string">'showpos'</span>);
0551 
0552 disp(<span class="string">'Done'</span>);
0553 
0554 <span class="comment">% Reset flag to load weights</span>
0555 handles.noloadw = 1;
0556 
0557 <span class="comment">% Show file name</span>
0558 <span class="comment">% -------------------------------------------------------------------------</span>
0559 set(handles.loadweight,<span class="string">'String'</span>,handles.wmap);
0560 guidata(hObject, handles);
0561 
0562 <a name="_sub12" href="#_subfunctions" class="code">function loadanatomical_Callback(hObject, eventdata, handles)</a>
0563 <span class="comment">% hObject    handle to loadanatomical (see GCBO)</span>
0564 <span class="comment">% eventdata  reserved - to be defined in a future version of MATLAB</span>
0565 <span class="comment">% handles    structure with handles and user data (see GUIDATA)</span>
0566 
0567 <span class="comment">% Hints: get(hObject,'String') returns contents of loadanatomical as text</span>
0568 <span class="comment">%        str2double(get(hObject,'String')) returns contents of loadanatomical as a double</span>
0569 
0570 
0571 <span class="comment">% --- Executes during object creation, after setting all properties.</span>
0572 <a name="_sub13" href="#_subfunctions" class="code">function loadanatomical_CreateFcn(hObject, eventdata, handles)</a>
0573 <span class="comment">% hObject    handle to loadanatomical (see GCBO)</span>
0574 <span class="comment">% eventdata  reserved - to be defined in a future version of MATLAB</span>
0575 <span class="comment">% handles    empty - handles not created until after all CreateFcns called</span>
0576 
0577 <span class="comment">% Hint: edit controls usually have a white background on Windows.</span>
0578 <span class="comment">%       See ISPC and COMPUTER.</span>
0579 <span class="keyword">if</span> ispc &amp;&amp; isequal(get(hObject,<span class="string">'BackgroundColor'</span>), get(0,<span class="string">'defaultUicontrolBackgroundColor'</span>))
0580     set(hObject,<span class="string">'BackgroundColor'</span>,<span class="string">'white'</span>);
0581 <span class="keyword">end</span>
0582 
0583 
0584 <span class="comment">% --- Executes on button press in anatomicalbutton.</span>
0585 <a name="_sub14" href="#_subfunctions" class="code">function anatomicalbutton_Callback(hObject, eventdata, handles)</a>
0586 <span class="comment">% hObject    handle to anatomicalbutton (see GCBO)</span>
0587 <span class="comment">% eventdata  reserved - to be defined in a future version of MATLAB</span>
0588 <span class="comment">% handles    structure with handles and user data (see GUIDATA)</span>
0589 
0590 <span class="comment">% Check if weight map and anatomical image exist and reset orthviews</span>
0591 <span class="comment">% -------------------------------------------------------------------------</span>
0592 <span class="keyword">if</span> ~isfield(handles,<span class="string">'wmap'</span>)
0593     spm_orthviews(<span class="string">'Reset'</span>);
0594 <span class="keyword">end</span>
0595 <span class="keyword">global</span> st
0596 st.fig = handles.figure1;
0597 <span class="keyword">if</span> ~isfield(handles,<span class="string">'aimg'</span>) || ~handles.noloadi
0598     img    = spm_select(1,<span class="string">'image'</span>,<span class="string">'Select anatomical image.'</span>);
0599 <span class="keyword">else</span>
0600     img = handles.aimg;
0601 <span class="keyword">end</span>
0602 
0603 <span class="comment">% Show anatomical image</span>
0604 <span class="comment">% -------------------------------------------------------------------------</span>
0605 rotate3d off
0606 st.fig = handles.figure1;
0607 handle = spm_orthviews(<span class="string">'Image'</span>, img, [0.5595 0.498 0.4182 0.3951]);
0608 cmap   = get(gcf,<span class="string">'Colormap'</span>);
0609 <span class="keyword">if</span> size(cmap,1)~=128
0610     spm_figure(<span class="string">'Colormap'</span>,<span class="string">'gray'</span>)
0611 <span class="keyword">end</span>
0612 
0613 handles.aimgh   = handle;
0614 handles.aimg    = img;
0615 handles.img     = 1;
0616 handles.noloadi = 1;
0617 
0618 <span class="comment">% Show file name</span>
0619 <span class="comment">% -------------------------------------------------------------------------</span>
0620 set(handles.loadanatomical,<span class="string">'String'</span>,handles.aimg);
0621 
0622 guidata(hObject, handles);
0623 
0624 
0625 <span class="comment">% --- Executes on selection change in foldmenu.</span>
0626 <a name="_sub15" href="#_subfunctions" class="code">function foldmenu_Callback(hObject, eventdata, handles)</a>
0627 <span class="comment">% hObject    handle to foldmenu (see GCBO)</span>
0628 <span class="comment">% eventdata  reserved - to be defined in a future version of MATLAB</span>
0629 <span class="comment">% handles    structure with handles and user data (see GUIDATA)</span>
0630 
0631 <span class="comment">% Hints: contents = cellstr(get(hObject,'String')) returns foldmenu contents as cell array</span>
0632 <span class="comment">%        contents{get(hObject,'Value')} returns selected item from foldmenu</span>
0633 
0634 <span class="comment">% Change weight map</span>
0635 <span class="comment">% -------------------------------------------------------------------------</span>
0636 <span class="keyword">if</span> ~handles.model_button
0637     <span class="keyword">if</span> isfield(handles,<span class="string">'vols'</span>)
0638         handles.noloadw = 1;
0639         handles.selectedcell = [];
0640         <a href="#_sub11" class="code" title="subfunction weightbutton_Callback(hObject, eventdata, handles)">weightbutton_Callback</a>(hObject, eventdata, handles);
0641     <span class="keyword">end</span>
0642 <span class="keyword">end</span>
0643 
0644 <span class="comment">% Update table and bar graph</span>
0645 m  = get(handles.classmenu,<span class="string">'Value'</span>);
0646 <span class="keyword">if</span> m==0
0647     m=1;
0648 <span class="keyword">end</span>
0649 mi = handles.mi;
0650 ffi = get(handles.foldmenu,<span class="string">'Value'</span>)-1;
0651 <span class="keyword">if</span> ffi == -1 <span class="comment">% for Mac issues with popup menus</span>
0652     ffi = 0;
0653 <span class="keyword">end</span>
0654 <span class="keyword">if</span> ffi==0 <span class="comment">% for average</span>
0655     ffi=length(get(handles.foldmenu,<span class="string">'String'</span>));
0656 <span class="keyword">end</span>
0657 <span class="keyword">if</span> isfield(handles.PRT.model(mi(m)).output,<span class="string">'weight_ROI'</span>) &amp;&amp;<span class="keyword">...</span><span class="comment"> % chosen model has ROI values</span>
0658        ~isempty(handles.PRT.model(mi(m)).output.weight_ROI)
0659    dat = handles.dattable;
0660    weights = handles.PRT.model(mi(m)).output.weight_ROI{handles.class}(:,ffi)*100;
0661    dat(:,2) = num2cell(weights);
0662    [vald,idwroi] = sort(weights,<span class="string">'descend'</span>);
0663    dat = dat(idwroi,:);
0664    set(handles.ROItable,<span class="string">'Data'</span>,dat);
0665    set(handles.ROItable,<span class="string">'visible'</span>,<span class="string">'on'</span>);
0666    set(handles.butt_load_labels,<span class="string">'visible'</span>,<span class="string">'on'</span>);
0667    
0668    <span class="comment">%Bar graph to show decrease in ROI weights</span>
0669    set(handles.axes1,<span class="string">'visible'</span>,<span class="string">'on'</span>)
0670    bar(handles.axes1,weights(idwroi));
0671    set(get(handles.axes1,<span class="string">'XLabel'</span>),<span class="string">'FontWeight'</span>,<span class="string">'demi'</span>)
0672    set(get(handles.axes1,<span class="string">'XLabel'</span>),<span class="string">'String'</span>,<span class="string">'ROI index'</span>)
0673    set(get(handles.axes1,<span class="string">'YLabel'</span>),<span class="string">'String'</span>,<span class="string">'ROI weight'</span>)
0674    set(get(handles.axes1,<span class="string">'YLabel'</span>),<span class="string">'FontWeight'</span>,<span class="string">'demi'</span>)    
0675    
0676    <span class="keyword">if</span> ~isempty(handles.datmod)
0677        datmod = handles.datmod;
0678        wemod = zeros(length(handles.nmods),handles.nfold+1);
0679         <span class="keyword">for</span> i=1:length(handles.nmods) <span class="comment">% get all the modalities</span>
0680             wemod(i,:) = [handles.PRT.model(mi(m)).output.weight_MOD{i}];
0681         <span class="keyword">end</span>
0682         datmod(:,2) = num2cell(wemod(:,ffi)*100);
0683         [vald,idwmod] = sort(wemod(:,ffi),<span class="string">'descend'</span>);
0684         datmod= datmod(idwmod,:);
0685         set(handles.modtable,<span class="string">'Data'</span>,datmod)
0686         set(handles.modtable,<span class="string">'Visible'</span>,<span class="string">'on'</span>)
0687    <span class="keyword">end</span>
0688 <span class="keyword">end</span>
0689 guidata(hObject, handles);
0690 
0691 
0692 
0693 
0694 <span class="comment">% --- Executes during object creation, after setting all properties.</span>
0695 <a name="_sub16" href="#_subfunctions" class="code">function foldmenu_CreateFcn(hObject, eventdata, handles)</a>
0696 <span class="comment">% hObject    handle to foldmenu (see GCBO)</span>
0697 <span class="comment">% eventdata  reserved - to be defined in a future version of MATLAB</span>
0698 <span class="comment">% handles    empty - handles not created until after all CreateFcns called</span>
0699 
0700 <span class="comment">% Hint: popupmenu controls usually have a white background on Windows.</span>
0701 <span class="comment">%       See ISPC and COMPUTER.</span>
0702 <span class="keyword">if</span> ispc &amp;&amp; isequal(get(hObject,<span class="string">'BackgroundColor'</span>), get(0,<span class="string">'defaultUicontrolBackgroundColor'</span>))
0703     set(hObject,<span class="string">'BackgroundColor'</span>,<span class="string">'white'</span>);
0704 <span class="keyword">end</span>
0705 
0706 
0707 <span class="comment">% --- Executes on selection change in classmenu.</span>
0708 <a name="_sub17" href="#_subfunctions" class="code">function classmenu_Callback(hObject, eventdata, handles)</a>
0709 <span class="comment">% hObject    handle to classmenu (see GCBO)</span>
0710 <span class="comment">% eventdata  reserved - to be defined in a future version of MATLAB</span>
0711 <span class="comment">% handles    structure with handles and user data (see GUIDATA)</span>
0712 
0713 <span class="comment">% Hints: contents = cellstr(get(hObject,'String')) returns classmenu contents as cell array</span>
0714 <span class="comment">%        contents{get(hObject,'Value')} returns selected item from classmenu</span>
0715 
0716 <span class="comment">% Hints: contents = cellstr(get(hObject,'String')) returns classmenu contents as cell array</span>
0717 <span class="comment">%        contents{get(hObject,'Value')} returns selected item from classmenu</span>
0718 m  = get(handles.classmenu,<span class="string">'Value'</span>);
0719 <span class="keyword">if</span> m==0
0720     m=1;
0721 <span class="keyword">end</span>
0722 mi = handles.mi;
0723 
0724 <span class="comment">% Set the list of weight images generated for this model</span>
0725 list = handles.PRT.model(mi(m)).output.weight_img;
0726 <span class="keyword">if</span> ~isempty(list)
0727     set(handles.imagemenu,<span class="string">'String'</span>,list)
0728 <span class="keyword">else</span>
0729     set(handles.imagemenu,<span class="string">'Enable'</span>,<span class="string">'off'</span>)
0730 <span class="keyword">end</span>
0731 set(handles.imagemenu,<span class="string">'Value'</span>,1);
0732 handles.class = 1;
0733 
0734 <span class="comment">% Get the modalities in the model if multiple kernels and multiple</span>
0735 <span class="comment">% modalities</span>
0736 in.fs_name = handles.PRT.model(mi(m)).input.fs(1).fs_name;
0737 fid = <a href="prt_init_fs.html" class="code" title="function [fid,PRT,tocomp] = prt_init_fs(PRT, in, mids,mask,precmask,headers)">prt_init_fs</a>(handles.PRT,in);
0738 handles.fid = fid;
0739 <span class="keyword">if</span> ~isempty(strfind(handles.PRT.model(mi(m)).input.machine.function,<span class="string">'MKL'</span>)) &amp;&amp; <span class="keyword">...</span>
0740         handles.PRT.fs(fid).multkernel
0741     nmod = length(handles.PRT.fs(fid).modality);
0742     mods = cell(nmod,1);
0743     <span class="keyword">for</span> i=1:nmod
0744         mods{i} = handles.PRT.fs(fid).modality(i).mod_name;
0745     <span class="keyword">end</span>
0746     handles.summed = 0;
0747 <span class="keyword">elseif</span> ~isempty(strfind(handles.PRT.model(mi(m)).input.machine.function,<span class="string">'MKL'</span>)) &amp;&amp; <span class="keyword">...</span>
0748         ~handles.PRT.fs(fid).multkernel
0749     mods{1} = handles.PRT.fs(fid).modality(1).mod_name;
0750     handles.summed = 0; <span class="comment">% either summed modalities or only one</span>
0751 <span class="keyword">else</span>
0752     mods{1} = handles.PRT.fs(fid).modality(1).mod_name;
0753     handles.summed = 1; <span class="comment">% either summed modalities or only one</span>
0754 <span class="keyword">end</span>
0755 handles.nmods = mods;
0756 guidata(hObject, handles);
0757 <a href="#_sub19" class="code" title="subfunction imagemenu_Callback(hObject, eventdata, handles)">imagemenu_Callback</a>(hObject,eventdata,handles)
0758 handles = guidata(hObject);
0759 guidata(hObject, handles);
0760 
0761 
0762 <span class="comment">% --- Executes during object creation, after setting all properties.</span>
0763 <a name="_sub18" href="#_subfunctions" class="code">function classmenu_CreateFcn(hObject, eventdata, handles)</a>
0764 <span class="comment">% hObject    handle to classmenu (see GCBO)</span>
0765 <span class="comment">% eventdata  reserved - to be defined in a future version of MATLAB</span>
0766 <span class="comment">% handles    empty - handles not created until after all CreateFcns called</span>
0767 
0768 <span class="comment">% Hint: popupmenu controls usually have a white background on Windows.</span>
0769 <span class="comment">%       See ISPC and COMPUTER.</span>
0770 <span class="keyword">if</span> ispc &amp;&amp; isequal(get(hObject,<span class="string">'BackgroundColor'</span>), get(0,<span class="string">'defaultUicontrolBackgroundColor'</span>))
0771     set(hObject,<span class="string">'BackgroundColor'</span>,<span class="string">'white'</span>);
0772 <span class="keyword">end</span>
0773 
0774 <span class="comment">% --- Executes on selection change in imagemenu.</span>
0775 <a name="_sub19" href="#_subfunctions" class="code">function imagemenu_Callback(hObject, eventdata, handles)</a>
0776 <span class="comment">% hObject    handle to imagemenu (see GCBO)</span>
0777 <span class="comment">% eventdata  reserved - to be defined in a future version of MATLAB</span>
0778 <span class="comment">% handles    structure with handles and user data (see GUIDATA)</span>
0779 
0780 <span class="comment">% Hints: contents = get(hObject,'String') returns imagemenu contents as cell array</span>
0781 <span class="comment">%        contents{get(hObject,'Value')} returns selected item from imagemenu</span>
0782 <span class="comment">% Get models (classmenu), classes (imagemenu) and folds (foldmenu)</span>
0783 m  = get(handles.classmenu,<span class="string">'Value'</span>);
0784 <span class="keyword">if</span> m==0
0785     m=1;
0786 <span class="keyword">end</span>
0787 mi = handles.mi;
0788 handles.nfold = length(handles.PRT.model(mi(m)).output.fold);
0789 
0790 
0791 folds{1}      = <span class="string">'All folds / Average'</span>;
0792 <span class="keyword">for</span> f = 1:handles.nfold
0793     folds{f+1} = num2str(f);
0794 <span class="keyword">end</span>
0795 
0796 <span class="comment">% Set folds and call fold function to plot the weights for that model</span>
0797 handles.folds = folds;
0798 set(handles.foldmenu,<span class="string">'String'</span>,handles.folds);
0799 
0800 disp_vox = get(handles.disp_voxels,<span class="string">'Value'</span>);
0801 set(handles.disp_voxels,<span class="string">'Enable'</span>,<span class="string">'on'</span>)
0802 
0803 <span class="comment">%get the fold to display</span>
0804 ffi = get(handles.foldmenu,<span class="string">'Value'</span>)-1;
0805 <span class="keyword">if</span> ffi == -1 <span class="comment">% for Mac issues with popup menus</span>
0806     ffi = 0;
0807 <span class="keyword">end</span>
0808 <span class="keyword">if</span> ffi==0 <span class="comment">% for average</span>
0809     ffi=length(get(handles.foldmenu,<span class="string">'String'</span>));
0810 <span class="keyword">end</span>
0811 
0812 <span class="comment">% get the image to display</span>
0813 handles.class = get(handles.imagemenu,<span class="string">'Value'</span>);
0814 <span class="keyword">if</span> handles.class ==0
0815     handles.class = 1;
0816 <span class="keyword">end</span>
0817 
0818 <span class="comment">% Compare the name of the image with the name of the modalities to obtain</span>
0819 <span class="comment">% the index of the modality</span>
0820 nim = get(handles.imagemenu,<span class="string">'String'</span>);
0821 <span class="keyword">for</span> i = 1:length(handles.nmods)
0822     <span class="keyword">if</span> ~isempty(strfind(nim,char(handles.nmods{i})))
0823         mids = i;
0824     <span class="keyword">end</span>
0825 <span class="keyword">end</span>
0826 
0827 
0828 <span class="comment">% Initialize the table</span>
0829 <span class="comment">% -------------------------------------------------------------------------</span>
0830 
0831 flagmodMKL = 0; <span class="comment">% One weight per modality?</span>
0832 
0833 <span class="comment">% chosen model has ROI values or weights per modality : create the table</span>
0834 <span class="keyword">if</span> isfield(handles.PRT.model(mi(m)).output,<span class="string">'weight_ROI'</span>) &amp;&amp;<span class="keyword">...</span><span class="comment"> </span>
0835        ~isempty(handles.PRT.model(mi(m)).output.weight_ROI)
0836    
0837    in = struct();
0838    in.fs_name = handles.PRT.model(mi(m)).input.fs(1).fs_name;
0839    fid = <a href="prt_init_fs.html" class="code" title="function [fid,PRT,tocomp] = prt_init_fs(PRT, in, mids,mask,precmask,headers)">prt_init_fs</a>(handles.PRT,in);
0840    <span class="comment">% For each modality if multiple modalities in multiple kernel settings</span>
0841    <span class="keyword">if</span> handles.PRT.fs(fid).multkernel &amp;&amp; ~handles.summed
0842        stm = length(handles.nmods); <span class="comment">%if multiple modalities used in multiple kernels</span>
0843    <span class="keyword">else</span>
0844        stm =1; <span class="comment">% if modalities concatenated or only one</span>
0845    <span class="keyword">end</span>
0846    <span class="keyword">if</span> ~iscell(handles.PRT.fs(fid).atlas_name)
0847        handles.PRT.fs(fid).atlas_name = {handles.PRT.fs(fid).atlas_name};
0848    <span class="keyword">end</span>
0849    <span class="comment">% Get the number of ROIs and their labels for each modality</span>
0850    handles.num_roi = [];
0851    
0852    <span class="keyword">for</span> i = 1:stm
0853        <span class="keyword">if</span> isfield(handles.PRT.fs(fid).modality(i),<span class="string">'num_ROI'</span>) &amp;&amp; ~handles.summed
0854             num_roi = handles.PRT.fs(fid).modality(i).num_ROI; <span class="comment">% MKL on regions</span>
0855             atl_name = handles.PRT.fs(fid).atlas_name{i};
0856        <span class="keyword">else</span>
0857            num_roi = 1:size(handles.PRT.model(mi(m)).output.weight_ROI{handles.class},1);
0858            <span class="keyword">if</span> isfield(handles.PRT.model(mi(m)).output,<span class="string">'weight_atlas'</span>) &amp;&amp; <span class="keyword">...</span>
0859                    ~isempty(handles.PRT.model(mi(m)).output.weight_atlas)
0860                 atl_name = handles.PRT.model(mi(m)).output.weight_atlas{i} ; <span class="comment">%summarized weights</span>
0861            <span class="keyword">else</span>
0862                atl_name = []; <span class="comment">%MKL on modalities</span>
0863            <span class="keyword">end</span>
0864        <span class="keyword">end</span>
0865        handles.num_roi(:,i) = num_roi;
0866        
0867        <span class="comment">% Get the labels if they are stored in a .mat along the atlas file for</span>
0868        <span class="comment">% MKL on regions and summarisation</span>
0869        <span class="keyword">if</span> ~isempty(atl_name)
0870            [a,b]=fileparts(atl_name);
0871            <span class="keyword">try</span>
0872                load(fullfile(a,[<span class="string">'Labels_'</span>,b,<span class="string">'.mat'</span>]))
0873                <span class="keyword">try</span>
0874                    handles.labels{mi(m)}{i}=ROI_names;
0875                <span class="keyword">catch</span>
0876                    disp(<span class="string">'No variable ROI_names found, generic names used'</span>)
0877                <span class="keyword">end</span>
0878            <span class="keyword">catch</span>
0879                  disp(<span class="string">'No file containing the names of the ROIs found, generic names used'</span>)
0880            <span class="keyword">end</span>
0881            <span class="keyword">if</span> ~isfield(handles,<span class="string">'labels'</span>) || <span class="keyword">...</span>
0882                    isempty(handles.labels{mi(m)}) || <span class="keyword">...</span>
0883                    isempty(handles.labels{mi(m)}{i})
0884                label=cell(length(num_roi),1);
0885                <span class="keyword">for</span> j=1:length(num_roi)
0886                    label{j} = [<span class="string">'ROI_'</span>,num2str(num_roi(j))];
0887                <span class="keyword">end</span>
0888            <span class="keyword">else</span>
0889                <span class="keyword">if</span> isfield(handles.PRT.fs(fid),<span class="string">'igood_kerns'</span>) &amp;&amp; <span class="keyword">...</span>
0890                        length(handles.PRT.fs(fid).igood_kerns)==length(num_roi) &amp;&amp;<span class="keyword">...</span>
0891                        ~handles.summed
0892                     label = handles.labels{mi(m)}{i}(handles.PRT.fs(fid).igood_kerns); <span class="comment">%take 0 kernels out</span>
0893                     handles.num_roi(:,i) = handles.PRT.fs(fid).igood_kerns;
0894                <span class="keyword">else</span>
0895                    <span class="keyword">try</span>
0896                        label = handles.labels{mi(m)}{i}(num_roi);
0897                    <span class="keyword">catch</span>
0898                        <span class="keyword">if</span> length(num_roi)==length(handles.labels{mi(m)}{i})  <span class="comment">% match between labels and number of regions</span>
0899                            label = handles.labels{mi(m)}{i}(num_roi);
0900                            handles.num_roi(:,i) = num_roi;
0901                        <span class="keyword">elseif</span> length(num_roi)==length(handles.labels{mi(m)}{i})+1    <span class="comment">%missing the 'others' region</span>
0902                            handles.labels{mi(m)}{i} = [{<span class="string">'others'</span>};handles.labels{mi(m)}{i}];
0903                            label = handles.labels{mi(m)}{i}(num_roi);
0904                            handles.num_roi(:,i) = num_roi;
0905                        <span class="keyword">else</span>
0906                            warning(<span class="string">'prt_ui_disp_weights:LabelsDoNotCorrespondtoROI'</span>,<span class="keyword">...</span><span class="comment"> % could not use file</span>
0907                                <span class="string">'Number of labels in .mat does not correspond to number of ROIs'</span>);
0908                            label=cell(length(num_roi(:,i)),1);
0909                            <span class="keyword">for</span> j=1:length(num_roi(:,i))
0910                                label{j} = [<span class="string">'ROI_'</span>,num2str(num_roi(j,i))];
0911                            <span class="keyword">end</span>
0912                        <span class="keyword">end</span>
0913                    <span class="keyword">end</span>
0914 
0915                <span class="keyword">end</span>
0916            <span class="keyword">end</span> 
0917            lc = {<span class="string">'ROI label'</span>,<span class="string">'ROI weight (%)'</span>};
0918            xlabel = <span class="string">'Index in table'</span>;
0919            ylabel = <span class="string">'Weight'</span>;
0920            set(handles.butt_load_labels,<span class="string">'Visible'</span>,<span class="string">'on'</span>)
0921            set(handles.saveweight,<span class="string">'Visible'</span>,<span class="string">'on'</span>)
0922        <span class="keyword">else</span> <span class="comment">%get names of the modalities for MKL on modalities</span>
0923            label = cell(length(handles.PRT.fs(fid).modality),1);
0924            <span class="keyword">for</span> j = 1:length(handles.PRT.fs(fid).modality)
0925                label{j} = char(handles.PRT.fs(fid).modality(j).mod_name);
0926            <span class="keyword">end</span>
0927            lc = {<span class="string">'Modality'</span>,<span class="string">'Mod. weight (%)'</span>};
0928            xlabel = <span class="string">'Index in table'</span>;
0929            ylabel = <span class="string">'Weight'</span>;
0930            set(handles.butt_load_labels,<span class="string">'Visible'</span>,<span class="string">'off'</span>)
0931            set(handles.saveweight,<span class="string">'Visible'</span>,<span class="string">'off'</span>)
0932        <span class="keyword">end</span>
0933    <span class="keyword">end</span>
0934    dat(:,1) = label;
0935    weights = handles.PRT.model(mi(m)).output.weight_ROI{handles.class}(:,ffi)*100;
0936    dat(:,2) = num2cell(weights);   
0937    
0938    <span class="comment">% Fill the table with ROI size if ROIs</span>
0939    <span class="keyword">if</span> ~isempty(strfind(handles.PRT.model(mi(m)).input.machine.function,<span class="string">'MKL'</span>)) &amp;&amp; <span class="keyword">...</span>
0940            handles.PRT.fs(fid).multkernelROI  <span class="comment">%Multiple kernel learning on ROIs</span>
0941        <span class="keyword">if</span> isfield(handles.PRT.fs(fid).modality,<span class="string">'idfeat_img'</span>)&amp;&amp; <span class="keyword">...</span><span class="comment"> % Get the indexes of each ROI in the image</span>
0942                ~isempty(handles.PRT.fs(fid).modality(mids).idfeat_img)
0943            lc = [lc,{<span class="string">'ROI size (vox)'</span>}];
0944            <span class="keyword">for</span> i=1:length(handles.PRT.fas)
0945                <span class="keyword">if</span> strcmpi(handles.PRT.fs(fid).modality(mids).mod_name,<span class="keyword">...</span>
0946                        handles.PRT.fas(i).mod_name)
0947                    mid = i;
0948                <span class="keyword">end</span>
0949            <span class="keyword">end</span>
0950            idfeat = handles.PRT.fas(mid).idfeat_img;
0951            <span class="keyword">if</span> isempty(handles.PRT.fs(fid).modality(mids).idfeat_fas) <span class="comment">% get the 2nd level masking</span>
0952                idfeat_fas = 1:length(idfeat);
0953            <span class="keyword">else</span>
0954                idfeat_fas = handles.PRT.fs(fid).modality(mids).idfeat_fas;
0955            <span class="keyword">end</span>
0956            handles.idfeat_roi = cell(length(handles.PRT.fs(fid).modality(mids).idfeat_img),1);
0957            <span class="keyword">for</span> i = 1:length(handles.PRT.fs(fid).modality(mids).idfeat_img)
0958                dat(i,3) = {length(handles.PRT.fs(fid).modality(mids).idfeat_img{i})};
0959                handles.idfeat_roi{i} = idfeat(idfeat_fas(handles.PRT.fs(fid).modality(mids).idfeat_img{i}));
0960            <span class="keyword">end</span>
0961        <span class="keyword">end</span>
0962        set(handles.disp_regions,<span class="string">'Enable'</span>,<span class="string">'on'</span>)
0963        flagmodMKL = 0;
0964    <span class="keyword">elseif</span> isfield(handles.PRT.model(mi(m)).output,<span class="string">'weight_idfeatroi'</span>) &amp;&amp;<span class="keyword">...</span><span class="comment"> % Summarizing the weights for ROI</span>
0965            ~isempty(handles.PRT.model(mi(m)).output.weight_idfeatroi) <span class="comment">% Get the indexes of each ROI in the image</span>
0966        lc = [lc,{<span class="string">'ROI size (vox)'</span>}];
0967        handles.idfeat_roi = cell(length(handles.PRT.model(mi(m)).output.weight_idfeatroi{handles.class}),1);
0968        <span class="keyword">for</span> i = 1:length(handles.PRT.model(mi(m)).output.weight_idfeatroi{handles.class})
0969            dat(i,3) = {length(handles.PRT.model(mi(m)).output.weight_idfeatroi{handles.class}{i})};
0970            handles.idfeat_roi{i} = handles.PRT.model(mi(m)).output.weight_idfeatroi{handles.class}{i};
0971        <span class="keyword">end</span>
0972        set(handles.disp_regions,<span class="string">'Enable'</span>,<span class="string">'on'</span>)
0973        flagmodMKL = 0;
0974    <span class="keyword">else</span> <span class="comment">% if MKL on modalities, do not fill third column and do not display weights per region</span>
0975        set(handles.disp_regions,<span class="string">'Enable'</span>,<span class="string">'off'</span>)
0976        flagmodMKL = 1;
0977    <span class="keyword">end</span> 
0978    
0979    <span class="comment">% Compute Expected Ranking for model</span>
0980    w_all = handles.PRT.model(mi(m)).output.weight_ROI{handles.class}(:,1:handles.nfold)*100;
0981    <span class="comment">%take 0 columns out of the computation</span>
0982    mw = min(w_all);
0983    mxw = max(w_all);
0984    id0 = find(mw==mxw);
0985    id0 = id0(mw(id0)==0);
0986    id = 1:size(w_all,2);
0987    idtr = setdiff(id,id0);
0988    <span class="keyword">if</span> isempty(idtr)   <span class="comment">% if a modality has always 0 weights</span>
0989        erwn=NaN*ones(length(num_roi),1);
0990    <span class="keyword">else</span>
0991        w_all = w_all(:,idtr);
0992        <span class="comment">%deal with NaNs</span>
0993        [d1,d2]=sort(w_all,1,<span class="string">'descend'</span>);
0994        isn=find(isnan(w_all(:,1)));
0995        d3=1:length(isn);
0996        d4=length(isn)+1:size(d1,1);
0997        ihn=[d2(d4,:);d2(d3,:)];
0998        [d1,dwn]=sort(ihn);
0999        erwn=zeros(length(num_roi),1);
1000        <span class="keyword">for</span> i=1:length(num_roi)
1001            <span class="keyword">for</span> j=1:length(num_roi)
1002                tmp=length(find(dwn(i,1:end-1)==j));
1003                erwn(i)=erwn(i)+j*tmp;
1004            <span class="keyword">end</span>
1005        <span class="keyword">end</span>
1006        erwn=erwn/length(idtr);
1007    <span class="keyword">end</span>
1008    
1009    dat = [dat, num2cell(erwn)]; 
1010    lc = [lc,{<span class="string">'Exp. Ranking'</span>}];
1011    handles.dattable = dat;
1012    [vald,idwroi] = sort(weights,<span class="string">'descend'</span>);
1013    handles.sort_roi= idwroi;
1014 <span class="keyword">else</span>
1015     <span class="comment">% Cut window</span>
1016     set(handles.disp_regions,<span class="string">'Enable'</span>,<span class="string">'off'</span>)
1017 <span class="keyword">end</span>
1018 
1019 <span class="keyword">if</span> ~iscell(handles.PRT.model(mi(m)).output.weight_img)
1020     handles.PRT.model(mi(m)).output.weight_img={handles.PRT.model(mi(m)).output.weight_img};
1021 <span class="keyword">end</span>
1022 
1023 <span class="comment">% Select the image to display and check whether its ROI version exists</span>
1024 <span class="keyword">if</span> disp_vox
1025     fntl = handles.PRT.model(mi(m)).output.weight_img{handles.class};
1026     set(handles.disp_voxels,<span class="string">'Value'</span>,1)
1027     set(handles.disp_regions,<span class="string">'Value'</span>,0)
1028 <span class="keyword">elseif</span> ~disp_vox &amp;&amp; isfield(handles.PRT.model(mi(m)).output,<span class="string">'weight_ROI'</span>) &amp;&amp;<span class="keyword">...</span><span class="comment"> % chosen model has ROI values</span>
1029        ~isempty(handles.PRT.model(mi(m)).output.weight_ROI{handles.class})
1030     fntl = [<span class="string">'ROI_'</span>,handles.PRT.model(mi(m)).output.weight_img{handles.class}];<span class="comment">%get only first image for now</span>
1031     set(handles.disp_voxels,<span class="string">'Value'</span>,0)
1032     set(handles.disp_regions,<span class="string">'Value'</span>,1)
1033 <span class="keyword">else</span>
1034     beep
1035     disp(<span class="string">'Weights per region selected, but no ROI_ image found'</span>)
1036     disp(<span class="string">'Displaying image of weights per voxels'</span>)
1037     fntl = handles.PRT.model(mi(m)).output.weight_img{handles.class};
1038     set(handles.disp_voxels,<span class="string">'Value'</span>,1)
1039     set(handles.disp_regions,<span class="string">'Value'</span>,0)
1040 <span class="keyword">end</span>
1041 
1042 <span class="comment">% Call weightbutton to display the chosen image</span>
1043 <span class="keyword">if</span> exist([handles.prtdir,filesep,fntl,<span class="string">'.img'</span>],<span class="string">'file'</span>) || <span class="keyword">...</span>
1044         exist([handles.prtdir,filesep,fntl],<span class="string">'file'</span>)
1045     [a,b] = fileparts(fntl);
1046     handles.wmap = [handles.prtdir,filesep,b,<span class="string">'.img'</span>];
1047     V               = spm_vol(handles.wmap);
1048     handles.vols{1} = V;
1049     handles.noloadw = 1;
1050     handles.model_button = 0;
1051     handles.selectedcell = [];
1052     <span class="comment">% Update handles structure</span>
1053     guidata(hObject, handles);
1054     <a href="#_sub11" class="code" title="subfunction weightbutton_Callback(hObject, eventdata, handles)">weightbutton_Callback</a>(hObject, eventdata, handles);
1055 <span class="keyword">end</span>
1056 
1057 <span class="comment">% % Compute homogeneity of ROIs if MKL on ROIs or summarizing</span>
1058 <span class="comment">% if ~flagmodMKL &amp;&amp; isfield(handles.PRT.model(mi(m)).output,'weight_ROI') &amp;&amp;... % chosen model has ROI values</span>
1059 <span class="comment">%        ~isempty(handles.PRT.model(mi(m)).output.weight_ROI) &amp;&amp;...</span>
1060 <span class="comment">%         isfield(handles,'wmap') &amp;&amp; ~isempty(handles.wmap)</span>
1061 <span class="comment">%</span>
1062 <span class="comment">%     % Get homogeneity of each ROI in terms of sign from the image</span>
1063 <span class="comment">%     dat = handles.dattable;</span>
1064 <span class="comment">%     [vald,idwroi] = sort([dat{:,2}],'descend');</span>
1065 <span class="comment">%     hom = zeros(length(vald),handles.nfold+1);</span>
1066 <span class="comment">%     for f = 1:handles.nfold+1</span>
1067 <span class="comment">%         imtl = V(f);</span>
1068 <span class="comment">%         vv = spm_read_vols(imtl);</span>
1069 <span class="comment">%         for i = 1:length(vald) %for each ROI</span>
1070 <span class="comment">%             val = vv(handles.idfeat_roi{i});</span>
1071 <span class="comment">%             hom(i,f) = length(find(val&gt;0))/length(val);</span>
1072 <span class="comment">%         end</span>
1073 <span class="comment">%         if length(unique(hom(:,f)))==1 % probably all weights to zero</span>
1074 <span class="comment">%             hom(:,f) = NaN;</span>
1075 <span class="comment">%         end</span>
1076 <span class="comment">%     end</span>
1077 <span class="comment">%    handles.hom_roi = hom;</span>
1078 <span class="comment">%    dat =[dat, num2cell(hom(:,end)*100)];</span>
1079 <span class="comment">%    lc = [lc,{'# Pos. (%)'}];</span>
1080 <span class="comment">% end</span>
1081 
1082 <span class="comment">% Fill modality table in the case of multiple modalities and multiple ROIs</span>
1083 <span class="comment">% (whether summarized or MKL)</span>
1084 <span class="keyword">if</span> isfield(handles.PRT.model(mi(m)).output,<span class="string">'weight_MOD'</span>) &amp;&amp;<span class="keyword">...</span>
1085         ~isempty(handles.PRT.model(mi(m)).output.weight_MOD{handles.class}) &amp;&amp; <span class="keyword">...</span>
1086         ~flagmodMKL
1087     datmod = cell(length(handles.nmods),3);
1088     datmod(:,1) = handles.nmods;
1089     wemod = zeros(length(handles.nmods),handles.nfold+1);
1090     <span class="keyword">for</span> i=1:length(handles.nmods) <span class="comment">% get all the modalities</span>
1091         wemod(i,:) = [handles.PRT.model(mi(m)).output.weight_MOD{i}];
1092     <span class="keyword">end</span>
1093     datmod(:,2) = num2cell(wemod(:,ffi)*100);
1094     <span class="comment">% Compute Expected Ranking for modalities</span>
1095     <span class="comment">%take 0 columns out of the computation</span>
1096     wem = wemod(:,1:handles.nfold);
1097     mw = min(wem);
1098     mxw = max(wem);
1099     id0 = find(mw==mxw);
1100     id0 = id0(mw(id0)==0);
1101     id = 1:size(wem,2);
1102     idtr = setdiff(id,id0);
1103     <span class="keyword">if</span> isempty(idtr)   <span class="comment">% if a modality has always 0 weights</span>
1104        erwn2=NaN*ones(length(handles.nmods),1);
1105     <span class="keyword">else</span>
1106        wem = wem(:,idtr);
1107        <span class="comment">%deal with NaNs</span>
1108        [d1,d2]=sort(wem,1,<span class="string">'descend'</span>);
1109        isn=find(isnan(wem(:,1)));
1110        d3=1:length(isn);
1111        d4=length(isn)+1:size(d1,1);
1112        ihn=[d2(d4,:);d2(d3,:)];
1113        [d1,dwn]=sort(ihn);
1114        erwn2=zeros(length(handles.nmods),1);
1115        <span class="keyword">for</span> i=1:size(wem,1)
1116            <span class="keyword">for</span> j=1:size(wem,1)
1117                tmp=length(find(dwn(i,1:end-1)==j));
1118                erwn2(i)=erwn2(i)+j*tmp;
1119            <span class="keyword">end</span>
1120        <span class="keyword">end</span>
1121        erwn2=erwn2/handles.nfold;
1122     <span class="keyword">end</span>
1123    datmod(:,3) = num2cell(erwn2);
1124    [vald,idwmod] = sort(wemod(:,ffi),<span class="string">'descend'</span>);
1125    handles.sort_mod= idwmod;
1126 <span class="keyword">else</span>
1127     datmod = [];
1128 <span class="keyword">end</span>
1129 handles.datmod = datmod;  
1130 
1131 
1132 <span class="comment">% Fill table and bar graph if needed</span>
1133 <span class="keyword">if</span> isfield(handles.PRT.model(mi(m)).output,<span class="string">'weight_ROI'</span>) &amp;&amp;<span class="keyword">...</span><span class="comment"> % chosen model has ROI or modality weight values</span>
1134         ~isempty(handles.PRT.model(mi(m)).output.weight_ROI) &amp;&amp;<span class="keyword">...</span>
1135         isfield(handles,<span class="string">'wmap'</span>) &amp;&amp; ~isempty(handles.wmap)
1136     handles.dattable = dat;
1137     
1138     dat = dat(handles.sort_roi,:);
1139     set(handles.ROItable,<span class="string">'Data'</span>,dat);
1140     set(handles.ROItable,<span class="string">'ColumnEditable'</span>,false(1,length(lc)));
1141     set(handles.ROItable,<span class="string">'ColumnName'</span>,lc);
1142     set(handles.ROItable,<span class="string">'visible'</span>,<span class="string">'on'</span>);
1143     
1144     <span class="comment">%Bar graph to show decrease in ROI weights</span>
1145     set(handles.axes1,<span class="string">'visible'</span>,<span class="string">'on'</span>)
1146     bar(handles.axes1,weights(idwroi));
1147     set(get(handles.axes1,<span class="string">'XLabel'</span>),<span class="string">'FontWeight'</span>,<span class="string">'demi'</span>)
1148     set(get(handles.axes1,<span class="string">'XLabel'</span>),<span class="string">'String'</span>,xlabel)
1149     set(get(handles.axes1,<span class="string">'YLabel'</span>),<span class="string">'String'</span>,ylabel)
1150     set(get(handles.axes1,<span class="string">'YLabel'</span>),<span class="string">'FontWeight'</span>,<span class="string">'demi'</span>)
1151     
1152 
1153    <span class="keyword">if</span> ~isempty(datmod)
1154       set(handles.modtable,<span class="string">'Visible'</span>,<span class="string">'on'</span>)
1155       set(handles.modtable,<span class="string">'Enable'</span>,<span class="string">'on'</span>)
1156       set(handles.modtable,<span class="string">'Data'</span>,datmod(handles.sort_mod,:))
1157       set(handles.modtable,<span class="string">'ColumnEditable'</span>,false(1,size(datmod,2)));
1158       set(handles.modtable,<span class="string">'ColumnName'</span>,{<span class="string">'Modality'</span>,<span class="string">'Weight (%)'</span>,<span class="string">'Exp. Ranking'</span>});
1159    <span class="keyword">else</span>
1160       set(handles.modtable,<span class="string">'Visible'</span>,<span class="string">'off'</span>)
1161       set(handles.modtable,<span class="string">'Enable'</span>,<span class="string">'off'</span>) 
1162    <span class="keyword">end</span>    
1163    
1164 <span class="keyword">else</span>
1165     cla(handles.axes1, <span class="string">'reset'</span>);
1166     set(handles.ROItable,<span class="string">'visible'</span>,<span class="string">'off'</span>);
1167     set(handles.axes1,<span class="string">'visible'</span>,<span class="string">'off'</span>);
1168     set(handles.butt_load_labels,<span class="string">'visible'</span>,<span class="string">'off'</span>);
1169     set(handles.saveweight,<span class="string">'Visible'</span>,<span class="string">'off'</span>)
1170     set(handles.modtable,<span class="string">'Visible'</span>,<span class="string">'off'</span>)
1171     set(handles.modtable,<span class="string">'Enable'</span>,<span class="string">'off'</span>)
1172 <span class="keyword">end</span>
1173 handles.flagmodMKL = flagmodMKL;
1174 handles.model_button = 0;
1175 guidata(hObject, handles);
1176 
1177 <span class="comment">% --- Executes during object creation, after setting all properties.</span>
1178 <a name="_sub20" href="#_subfunctions" class="code">function imagemenu_CreateFcn(hObject, eventdata, handles)</a>
1179 <span class="comment">% hObject    handle to imagemenu (see GCBO)</span>
1180 <span class="comment">% eventdata  reserved - to be defined in a future version of MATLAB</span>
1181 <span class="comment">% handles    empty - handles not created until after all CreateFcns called</span>
1182 
1183 <span class="comment">% Hint: popupmenu controls usually have a white background on Windows.</span>
1184 <span class="comment">%       See ISPC and COMPUTER.</span>
1185 <span class="keyword">if</span> ispc &amp;&amp; isequal(get(hObject,<span class="string">'BackgroundColor'</span>), get(0,<span class="string">'defaultUicontrolBackgroundColor'</span>))
1186     set(hObject,<span class="string">'BackgroundColor'</span>,<span class="string">'white'</span>);
1187 <span class="keyword">end</span>
1188 
1189 
1190 <a name="_sub21" href="#_subfunctions" class="code">function repedit_Callback(hObject, eventdata, handles)</a>
1191 <span class="comment">% hObject    handle to repedit (see GCBO)</span>
1192 <span class="comment">% eventdata  reserved - to be defined in a future version of MATLAB</span>
1193 <span class="comment">% handles    structure with handles and user data (see GUIDATA)</span>
1194 
1195 <span class="comment">% Hints: get(hObject,'String') returns contents of repedit as text</span>
1196 <span class="comment">%        str2double(get(hObject,'String')) returns contents of repedit as a double</span>
1197 
1198 
1199 <span class="comment">% --- Executes during object creation, after setting all properties.</span>
1200 <a name="_sub22" href="#_subfunctions" class="code">function repedit_CreateFcn(hObject, eventdata, handles)</a>
1201 <span class="comment">% hObject    handle to repedit (see GCBO)</span>
1202 <span class="comment">% eventdata  reserved - to be defined in a future version of MATLAB</span>
1203 <span class="comment">% handles    empty - handles not created until after all CreateFcns called</span>
1204 
1205 <span class="comment">% Hint: edit controls usually have a white background on Windows.</span>
1206 <span class="comment">%       See ISPC and COMPUTER.</span>
1207 <span class="keyword">if</span> ispc &amp;&amp; isequal(get(hObject,<span class="string">'BackgroundColor'</span>), get(0,<span class="string">'defaultUicontrolBackgroundColor'</span>))
1208     set(hObject,<span class="string">'BackgroundColor'</span>,<span class="string">'white'</span>);
1209 <span class="keyword">end</span>
1210 
1211 
1212 <span class="comment">% Show crosshairs position</span>
1213 <span class="comment">% -------------------------------------------------------------------------</span>
1214 <a name="_sub23" href="#_subfunctions" class="code">function showpos()</a>
1215 
1216 <span class="keyword">global</span> st
1217 
1218 mp13 = st.handles.mmedit;
1219 mp14 = st.handles.vxedit;
1220 tx20 = st.handles.posintensitytext;
1221 
1222 set(mp13,<span class="string">'String'</span>,sprintf(<span class="string">'%.1f %.1f %.1f'</span>,spm_orthviews(<span class="string">'Pos'</span>)));
1223 pos = spm_orthviews(<span class="string">'Pos'</span>,1);
1224 set(mp14,<span class="string">'String'</span>,sprintf(<span class="string">'%.1f %.1f %.1f'</span>,pos));
1225 set(tx20,<span class="string">'String'</span>,sprintf(<span class="string">'%g'</span>,spm_sample_vol(st.V,pos(1),pos(2),pos(3),st.hld)));
1226 
1227 cmap = get(gcf,<span class="string">'Colormap'</span>);
1228 <span class="keyword">if</span> size(cmap,1)~=128
1229     spm_figure(<span class="string">'Colormap'</span>,<span class="string">'gray-jet'</span>);
1230 <span class="keyword">end</span>
1231 
1232 
1233 <span class="comment">% --- Executes on button press in resetbutton.</span>
1234 <a name="_sub24" href="#_subfunctions" class="code">function resetbutton_Callback(hObject, eventdata, handles)</a>
1235 <span class="comment">% hObject    handle to resetbutton (see GCBO)</span>
1236 <span class="comment">% eventdata  reserved - to be defined in a future version of MATLAB</span>
1237 <span class="comment">% handles    structure with handles and user data (see GUIDATA)</span>
1238 spm_orthviews(<span class="string">'Reset'</span>);
1239 <span class="keyword">if</span> isfield(handles, <span class="string">'wmap'</span>), handles = rmfield(handles, <span class="string">'wmap'</span>); <span class="keyword">end</span>
1240 <span class="keyword">if</span> isfield(handles, <span class="string">'aimg'</span>), handles = rmfield(handles,<span class="string">'aimg'</span>); <span class="keyword">end</span>
1241 cla(handles.axes1, <span class="string">'reset'</span>);
1242 set(handles.ROItable,<span class="string">'visible'</span>,<span class="string">'off'</span>);
1243 set(handles.axes1,<span class="string">'visible'</span>,<span class="string">'off'</span>);
1244 set(handles.butt_load_labels,<span class="string">'visible'</span>,<span class="string">'off'</span>);
1245 set(handles.saveweight,<span class="string">'visible'</span>,<span class="string">'off'</span>);
1246 set(handles.modtable,<span class="string">'Visible'</span>,<span class="string">'off'</span>)
1247 set(handles.modtable,<span class="string">'Enable'</span>,<span class="string">'off'</span>)
1248 handles.noloadw = 0;
1249 guidata(hObject, handles);
1250 
1251 <span class="comment">% Save menu</span>
1252 <span class="comment">% -------------------------------------------------------------------------</span>
1253 <a name="_sub25" href="#_subfunctions" class="code">function savemenu_Callback(hObject, eventdata, handles)</a>
1254 <span class="comment">% hObject    handle to savemenu (see GCBO)</span>
1255 <span class="comment">% eventdata  reserved - to be defined in a future version of MATLAB</span>
1256 <span class="comment">% handles    structure with handles and user data (see GUIDATA)</span>
1257 wd=cd;
1258 cd(handles.prtdir)
1259 [filename, pathname] = uiputfile( <span class="keyword">...</span>
1260     {<span class="string">'*.png'</span>,<span class="string">'Portable Network Graphics (*.png)'</span>;<span class="keyword">...</span>
1261     <span class="string">'*.jpeg'</span>,<span class="string">'JPEG figure (*.jpeg)'</span>;<span class="keyword">...</span>
1262     <span class="string">'*.tiff'</span>,<span class="string">'Compressed TIFF figure (*.tiff)'</span>;<span class="keyword">...</span>
1263     <span class="string">'*.fig'</span>,<span class="string">'Matlab figure (*.fig)'</span>;<span class="keyword">...</span>
1264     <span class="string">'*.pdf'</span>,<span class="string">'Color PDF file (*.pdf)'</span>;<span class="keyword">...</span>
1265     <span class="string">'*.epsc'</span>,  <span class="string">'Encapsulated PostScript (*.eps)'</span>},<span class="keyword">...</span>
1266     <span class="string">'Save figure as'</span>,<span class="string">'.png'</span>);
1267 [a,b,c]=fileparts(filename);
1268 ext=[<span class="string">'-d'</span>,c(2:end)];
1269 
1270 <span class="comment">% Set the color of the different backgrounds and figure parameters to white</span>
1271 cf=get(handles.figure1,<span class="string">'Color'</span>);
1272 set(handles.figure1,<span class="string">'Color'</span>,[1,1,1])
1273 aa=get(handles.figure1,<span class="string">'children'</span>);
1274 xc=[];
1275 <span class="keyword">for</span> i=1:length(aa)
1276     <span class="keyword">if</span> strcmpi(get(aa(i),<span class="string">'type'</span>),<span class="string">'uipanel'</span>)
1277         <span class="keyword">try</span>
1278             xc=[xc;get(aa(i),<span class="string">'BackgroundColor'</span>)];
1279             set(aa(i),<span class="string">'BackgroundColor'</span>,[1 1 1])
1280         <span class="keyword">end</span>
1281         bb=get(aa(i),<span class="string">'children'</span>);
1282         <span class="keyword">if</span> ~isempty(bb)
1283             <span class="keyword">for</span> j=1:length(bb)
1284                 <span class="keyword">try</span>
1285                     xc=[xc;get(bb(j),<span class="string">'BackgroundColor'</span>)];
1286                     set(bb(j),<span class="string">'BackgroundColor'</span>,[1 1 1])
1287                 <span class="keyword">end</span>
1288                 <span class="keyword">if</span> strcmpi(get(bb(j),<span class="string">'type'</span>),<span class="string">'uipanel'</span>)
1289                     cc=get(bb(j),<span class="string">'children'</span>);
1290                     <span class="keyword">if</span> ~isempty(cc)
1291                         <span class="keyword">for</span> k=1:length(cc)
1292                             <span class="keyword">try</span>
1293                                 xc=[xc;get(cc(k),<span class="string">'BackgroundColor'</span>)];
1294                                 set(cc(k),<span class="string">'BackgroundColor'</span>,[1 1 1])
1295                             <span class="keyword">end</span>
1296                             <span class="keyword">if</span> strcmpi(get(cc(k),<span class="string">'type'</span>),<span class="string">'uipanel'</span>)
1297                                 dd=get(cc(k),<span class="string">'children'</span>);
1298                                 <span class="keyword">if</span> ~isempty(dd)
1299                                     <span class="keyword">for</span> l=1:length(dd)
1300                                         <span class="keyword">try</span>
1301                                             xc=[xc;get(dd(l),<span class="string">'BackgroundColor'</span>)];
1302                                             set(dd(l),<span class="string">'BackgroundColor'</span>,[1 1 1])
1303                                         <span class="keyword">end</span>
1304                                     <span class="keyword">end</span>
1305                                 <span class="keyword">end</span>
1306                             <span class="keyword">end</span>
1307                         <span class="keyword">end</span>
1308                     <span class="keyword">end</span>
1309                 <span class="keyword">end</span>
1310             <span class="keyword">end</span>
1311         <span class="keyword">end</span>
1312     <span class="keyword">end</span>
1313     <span class="keyword">if</span> ~strcmpi(get(aa(i),<span class="string">'type'</span>),<span class="string">'uimenu'</span>)
1314         <span class="keyword">try</span>
1315             xc=[xc;get(aa(i),<span class="string">'BackgroundColor'</span>)];
1316             set(aa(i),<span class="string">'BackgroundColor'</span>,[1 1 1])
1317         <span class="keyword">end</span>
1318     <span class="keyword">end</span>
1319 <span class="keyword">end</span>
1320 
1321 print(handles.figure1,ext,[pathname,filesep,b],<span class="string">'-r500'</span>)
1322 
1323 <span class="comment">% Set the color of the different backgrounds and figure parameters to white</span>
1324 set(handles.figure1,<span class="string">'Color'</span>,cf)
1325 scount=1;
1326 <span class="keyword">for</span> i=1:length(aa)
1327     <span class="keyword">if</span> strcmpi(get(aa(i),<span class="string">'type'</span>),<span class="string">'uipanel'</span>)
1328         <span class="keyword">try</span>
1329             set(aa(i),<span class="string">'BackgroundColor'</span>,xc(scount,:))
1330             scount=scount+1;
1331         <span class="keyword">end</span>
1332         bb=get(aa(i),<span class="string">'children'</span>);
1333         <span class="keyword">if</span> ~isempty(bb)
1334             <span class="keyword">for</span> j=1:length(bb)
1335                 <span class="keyword">try</span>
1336                     set(bb(j),<span class="string">'BackgroundColor'</span>,xc(scount,:))
1337                     scount=scount+1;
1338                 <span class="keyword">end</span>
1339                 <span class="keyword">if</span> strcmpi(get(bb(j),<span class="string">'type'</span>),<span class="string">'uipanel'</span>)
1340                     cc=get(bb(j),<span class="string">'children'</span>);
1341                     <span class="keyword">if</span> ~isempty(cc)
1342                         <span class="keyword">for</span> k=1:length(cc)
1343                             <span class="keyword">try</span>
1344                                 set(cc(k),<span class="string">'BackgroundColor'</span>,xc(scount,:))
1345                                 scount=scount+1;
1346                             <span class="keyword">end</span>
1347                             <span class="keyword">if</span> strcmpi(get(cc(k),<span class="string">'type'</span>),<span class="string">'uipanel'</span>)
1348                                 dd=get(cc(k),<span class="string">'children'</span>);
1349                                 <span class="keyword">if</span> ~isempty(dd)
1350                                     <span class="keyword">for</span> l=1:length(dd)
1351                                         <span class="keyword">try</span>
1352                                             set(dd(l),<span class="string">'BackgroundColor'</span>,xc(scount,:))
1353                                             scount=scount+1;
1354                                         <span class="keyword">end</span>
1355                                     <span class="keyword">end</span>
1356                                 <span class="keyword">end</span>
1357                             <span class="keyword">end</span>
1358                         <span class="keyword">end</span>
1359                     <span class="keyword">end</span>
1360                 <span class="keyword">end</span>
1361             <span class="keyword">end</span>
1362         <span class="keyword">end</span>
1363     <span class="keyword">elseif</span> ~strcmpi(get(aa(i),<span class="string">'type'</span>),<span class="string">'uimenu'</span>)
1364         <span class="keyword">try</span>
1365             set(aa(i),<span class="string">'BackgroundColor'</span>,xc(scount,:))
1366             scount=scount+1;
1367         <span class="keyword">end</span>
1368     <span class="keyword">end</span>
1369 <span class="keyword">end</span>
1370 
1371 cd(wd)
1372 
1373 <span class="comment">% --- Executes on selection change in table if it is a ROI label.</span>
1374 <a name="_sub26" href="#_subfunctions" class="code">function disp_weights_CellSelectionCallback(hObject,eventdata,handles)</a>
1375 <span class="comment">% hObject    handle to foldmenu (see GCBO)</span>
1376 <span class="comment">% eventdata  reserved - to be defined in a future version of MATLAB</span>
1377 <span class="comment">% handles    structure with handles and user data (see GUIDATA)</span>
1378 handles.selectedcell=eventdata.Indices;
1379 <span class="keyword">if</span> ~isempty(handles.selectedcell) &amp;&amp; handles.selectedcell(2)==1 &amp;&amp; <span class="keyword">...</span><span class="comment">% ROI label selected</span>
1380     ~handles.flagmodMKL
1381     <a href="#_sub11" class="code" title="subfunction weightbutton_Callback(hObject, eventdata, handles)">weightbutton_Callback</a>(hObject, eventdata, handles);
1382 <span class="keyword">else</span>
1383     handles.selectedcell = [];
1384 <span class="keyword">end</span>
1385 <span class="comment">% Update handles structure</span>
1386 guidata(hObject, handles);
1387 
1388 <span class="comment">% --- Executes on selection change in foldmenu.</span>
1389 <a name="_sub27" href="#_subfunctions" class="code">function listbox1_Callback(hObject, eventdata, handles)</a>
1390 <span class="comment">% hObject    handle to foldmenu (see GCBO)</span>
1391 <span class="comment">% eventdata  reserved - to be defined in a future version of MATLAB</span>
1392 <span class="comment">% handles    structure with handles and user data (see GUIDATA)</span>
1393 
1394 <span class="comment">% Hints: contents = get(hObject,'String') returns foldmenu contents as cell array</span>
1395 <span class="comment">%        contents{get(hObject,'Value')} returns selected item from foldmenu</span>
1396 
1397 
1398 <span class="comment">% --- Executes during object creation, after setting all properties.</span>
1399 <a name="_sub28" href="#_subfunctions" class="code">function listbox1_CreateFcn(hObject, eventdata, handles)</a>
1400 <span class="comment">% hObject    handle to foldmenu (see GCBO)</span>
1401 <span class="comment">% eventdata  reserved - to be defined in a future version of MATLAB</span>
1402 <span class="comment">% handles    empty - handles not created until after all CreateFcns called</span>
1403 
1404 <span class="comment">% Hint: listbox controls usually have a white background on Windows.</span>
1405 <span class="comment">%       See ISPC and COMPUTER.</span>
1406 <span class="keyword">if</span> ispc &amp;&amp; isequal(get(hObject,<span class="string">'BackgroundColor'</span>), get(0,<span class="string">'defaultUicontrolBackgroundColor'</span>))
1407     set(hObject,<span class="string">'BackgroundColor'</span>,<span class="string">'white'</span>);
1408 <span class="keyword">end</span>
1409 
1410 <span class="comment">% --- Executes on button press in butt_load_labels.</span>
1411 <a name="_sub29" href="#_subfunctions" class="code">function butt_load_labels_Callback(hObject, eventdata, handles)</a>
1412 <span class="comment">% hObject    handle to butt_load_labels (see GCBO)</span>
1413 <span class="comment">% eventdata  reserved - to be defined in a future version of MATLAB</span>
1414 <span class="comment">% handles    structure with handles and user data (see GUIDATA)</span>
1415 mi = handles.mi;
1416 m = get(handles.classmenu,<span class="string">'Value'</span>);
1417 <span class="keyword">if</span> m==0 <span class="comment">% Mac weird error with popup menus</span>
1418     m=1;
1419 <span class="keyword">end</span>
1420 mim = get(handles.imagemenu,<span class="string">'Value'</span>);
1421 <span class="keyword">if</span> mim==0
1422     mim=1;
1423 <span class="keyword">end</span>
1424 fname=spm_select(1,<span class="string">'.mat'</span>,<span class="string">'Select the file containing the names of the ROIs'</span>);
1425 <span class="keyword">if</span> isempty(fname)
1426     disp(<span class="string">'No file containing the names of the ROIs found, generic names used'</span>)
1427     handles.labels{mi(m)}{mim}=[];
1428 <span class="keyword">else</span>
1429     load(fname)
1430     <span class="keyword">try</span>
1431         handles.labels{mi(m)}{mim}=ROI_names;
1432     <span class="keyword">catch</span>
1433         disp(<span class="string">'No variable ROI_names found, generic names used'</span>)
1434     <span class="keyword">end</span>
1435 <span class="keyword">end</span>
1436 num_roi = handles.num_roi(:,mim);
1437 <span class="keyword">try</span>
1438     label = handles.labels{mi(m)}{mim}(num_roi);
1439 <span class="keyword">catch</span>
1440     <span class="keyword">if</span> length(num_roi)==length(handles.labels{mi(m)}{mim})  <span class="comment">% match between labels and number of regions</span>
1441         label = handles.labels{mi(m)}{mim}(num_roi);
1442     <span class="keyword">elseif</span> length(num_roi)==length(handles.labels{mi(m)}{mim})+1    <span class="comment">%missing the 'others' region</span>
1443         handles.labels{mi(m)}{mim} = [{<span class="string">'others'</span>};handles.labels{mi(m)}{mim}];
1444         label = handles.labels{mi(m)}{mim}(num_roi);
1445     <span class="keyword">else</span>
1446         warning(<span class="string">'prt_ui_disp_weights:LabelsDoNotCorrespondtoROI'</span>,<span class="keyword">...</span><span class="comment"> % could not use file</span>
1447             <span class="string">'Number of labels in .mat does not correspond to number of ROIs'</span>);
1448         label = [];
1449     <span class="keyword">end</span>
1450 <span class="keyword">end</span>
1451 <span class="keyword">if</span> ~isempty(handles.labels{mi(m)}{mim}) &amp;&amp; ~isempty(label)
1452     dat = handles.dattable;
1453     dat(:,1) = label;
1454     handles.dattable = dat;
1455     dat = dat(handles.sort_roi,:);
1456     set(handles.ROItable,<span class="string">'Data'</span>,dat);
1457     set(handles.ROItable,<span class="string">'visible'</span>,<span class="string">'on'</span>);
1458     guidata(hObject, handles);
1459 <span class="keyword">end</span>
1460 
1461 
1462 
1463 
1464 
1465 <span class="comment">% --- Executes on button press in disp_voxels.</span>
1466 <a name="_sub30" href="#_subfunctions" class="code">function disp_voxels_Callback(hObject, eventdata, handles)</a>
1467 <span class="comment">% hObject    handle to disp_voxels (see GCBO)</span>
1468 <span class="comment">% eventdata  reserved - to be defined in a future version of MATLAB</span>
1469 <span class="comment">% handles    structure with handles and user data (see GUIDATA)</span>
1470 
1471 <span class="comment">% Hint: get(hObject,'Value') returns toggle state of disp_voxels</span>
1472 
1473 <span class="comment">% Get folds and model indexes</span>
1474 m  = get(handles.classmenu,<span class="string">'Value'</span>);
1475 <span class="keyword">if</span> m==0
1476     m=1;
1477 <span class="keyword">end</span>
1478 mi = handles.mi;
1479 handles.nfold = length(handles.PRT.model(mi(m)).output.fold);
1480 ffi = get(handles.foldmenu,<span class="string">'Value'</span>)-1;
1481 <span class="keyword">if</span> ffi == -1 <span class="comment">% for Mac issues with popup menus</span>
1482     ffi = 0;
1483 <span class="keyword">end</span>
1484 <span class="keyword">if</span> ffi==0 <span class="comment">% for average</span>
1485     ffi=handles.nfold+1;
1486 <span class="keyword">end</span>
1487 
1488 <span class="comment">% Select which image to display: weights per voxels or regions</span>
1489 disp_vox = get(handles.disp_voxels,<span class="string">'Value'</span>);
1490 <span class="keyword">if</span> disp_vox
1491     fntl = handles.PRT.model(mi(m)).output.weight_img{handles.class};
1492     set(handles.disp_regions,<span class="string">'Value'</span>,0);
1493 <span class="keyword">else</span>
1494     fntl = [<span class="string">'ROI_'</span>,handles.PRT.model(mi(m)).output.weight_img{handles.class}];<span class="comment">%get only first image for now</span>
1495     set(handles.disp_regions,<span class="string">'Value'</span>,1);
1496     set(handles.disp_voxels,<span class="string">'Value'</span>,0);
1497 <span class="keyword">end</span>
1498 
1499 <span class="comment">%Load corresponding weight image if it exists</span>
1500 <span class="keyword">if</span> exist([handles.prtdir,filesep,fntl,<span class="string">'.img'</span>],<span class="string">'file'</span>) || <span class="keyword">...</span>
1501         exist([handles.prtdir,filesep,fntl],<span class="string">'file'</span>)
1502     [a,b] = fileparts(fntl);
1503     handles.wmap = [handles.prtdir,filesep,b,<span class="string">'.img'</span>];
1504     V               = spm_vol(handles.wmap);
1505     handles.vols{1} = V;
1506     handles.noloadw = 1;
1507     handles.model_button = 0;
1508     handles.selectedcell = [];
1509     <span class="comment">% Update handles structure</span>
1510     guidata(hObject, handles);
1511     <a href="#_sub11" class="code" title="subfunction weightbutton_Callback(hObject, eventdata, handles)">weightbutton_Callback</a>(hObject, eventdata, handles);
1512 <span class="keyword">else</span>
1513     beep
1514     disp(<span class="string">'Weight image does not exist for this model'</span>)
1515 <span class="keyword">end</span>
1516 
1517     <span class="comment">% Update handles structure</span>
1518     guidata(hObject, handles);
1519 
1520 <span class="comment">% --- Executes on button press in disp_regions.</span>
1521 <a name="_sub31" href="#_subfunctions" class="code">function disp_regions_Callback(hObject, eventdata, handles)</a>
1522 <span class="comment">% hObject    handle to disp_regions (see GCBO)</span>
1523 <span class="comment">% eventdata  reserved - to be defined in a future version of MATLAB</span>
1524 <span class="comment">% handles    structure with handles and user data (see GUIDATA)</span>
1525 
1526 <span class="comment">% Hint: get(hObject,'Value') returns toggle state of disp_regions</span>
1527 <span class="comment">% Get folds and model indexes</span>
1528 m  = get(handles.classmenu,<span class="string">'Value'</span>);
1529 <span class="keyword">if</span> m==0
1530     m=1;
1531 <span class="keyword">end</span>
1532 mi = handles.mi;
1533 handles.nfold = length(handles.PRT.model(mi(m)).output.fold);
1534 ffi = get(handles.foldmenu,<span class="string">'Value'</span>)-1;
1535 <span class="keyword">if</span> ffi == -1 <span class="comment">% for Mac issues with popup menus</span>
1536     ffi = 0;
1537 <span class="keyword">end</span>
1538 <span class="keyword">if</span> ffi==0 <span class="comment">% for average</span>
1539     ffi=handles.nfold+1;
1540 <span class="keyword">end</span>
1541 
1542 <span class="comment">% Select which image to display: weights per voxels or regions</span>
1543 disp_reg = get(handles.disp_regions,<span class="string">'Value'</span>);
1544 <span class="keyword">if</span> ~disp_reg
1545     fntl = handles.PRT.model(mi(m)).output.weight_img{handles.class};
1546     set(handles.disp_regions,<span class="string">'Value'</span>,0);
1547     set(handles.disp_voxels,<span class="string">'Value'</span>,1);
1548 <span class="keyword">else</span>
1549     fntl = [<span class="string">'ROI_'</span>,handles.PRT.model(mi(m)).output.weight_img{handles.class}];<span class="comment">%get only first image for now</span>
1550     set(handles.disp_regions,<span class="string">'Value'</span>,1);
1551     set(handles.disp_voxels,<span class="string">'Value'</span>,0);
1552 <span class="keyword">end</span>
1553 
1554 <span class="comment">%Load corresponding weight image if it exists</span>
1555 <span class="keyword">if</span> exist([handles.prtdir,filesep,fntl,<span class="string">'.img'</span>],<span class="string">'file'</span>) || <span class="keyword">...</span>
1556         exist([handles.prtdir,filesep,fntl],<span class="string">'file'</span>)
1557     [a,b] = fileparts(fntl);
1558     handles.wmap = [handles.prtdir,filesep,b,<span class="string">'.img'</span>];
1559     V               = spm_vol(handles.wmap);
1560     handles.vols{1} = V;
1561     handles.noloadw = 1;
1562     handles.model_button = 0;
1563     handles.selectedcell = [];
1564     <span class="comment">% Update handles structure</span>
1565     guidata(hObject, handles);
1566     <a href="#_sub11" class="code" title="subfunction weightbutton_Callback(hObject, eventdata, handles)">weightbutton_Callback</a>(hObject, eventdata, handles);
1567 <span class="keyword">else</span>
1568     beep
1569     disp(<span class="string">'Weight image does not exist for this model'</span>)
1570 <span class="keyword">end</span>
1571 
1572 <span class="comment">% Update handles structure</span>
1573 guidata(hObject, handles);
1574 
1575 
1576 
1577 <span class="comment">% --- Executes when entered data in editable cell(s) in ROItable.</span>
1578 <a name="_sub32" href="#_subfunctions" class="code">function ROItable_CellEditCallback(hObject, eventdata, handles)</a>
1579 <span class="comment">% hObject    handle to ROItable (see GCBO)</span>
1580 <span class="comment">% eventdata  structure with the following fields (see UITABLE)</span>
1581 <span class="comment">%    Indices: row and column indices of the cell(s) edited</span>
1582 <span class="comment">%    PreviousData: previous data for the cell(s) edited</span>
1583 <span class="comment">%    EditData: string(s) entered by the user</span>
1584 <span class="comment">%    NewData: EditData or its converted form set on the Data property. Empty if Data was not changed</span>
1585 <span class="comment">%    Error: error string when failed to convert EditData to appropriate value for Data</span>
1586 <span class="comment">% handles    structure with handles and user data (see GUIDATA)</span>
1587 
1588 
1589 
1590 <a name="_sub33" href="#_subfunctions" class="code">function edit7_Callback(hObject, eventdata, handles)</a>
1591 <span class="comment">% hObject    handle to edit7 (see GCBO)</span>
1592 <span class="comment">% eventdata  reserved - to be defined in a future version of MATLAB</span>
1593 <span class="comment">% handles    structure with handles and user data (see GUIDATA)</span>
1594 
1595 <span class="comment">% Hints: get(hObject,'String') returns contents of edit7 as text</span>
1596 <span class="comment">%        str2double(get(hObject,'String')) returns contents of edit7 as a double</span>
1597 
1598 
1599 <span class="comment">% --- Executes during object creation, after setting all properties.</span>
1600 <a name="_sub34" href="#_subfunctions" class="code">function edit7_CreateFcn(hObject, eventdata, handles)</a>
1601 <span class="comment">% hObject    handle to edit7 (see GCBO)</span>
1602 <span class="comment">% eventdata  reserved - to be defined in a future version of MATLAB</span>
1603 <span class="comment">% handles    empty - handles not created until after all CreateFcns called</span>
1604 
1605 <span class="comment">% Hint: edit controls usually have a white background on Windows.</span>
1606 <span class="comment">%       See ISPC and COMPUTER.</span>
1607 <span class="keyword">if</span> ispc &amp;&amp; isequal(get(hObject,<span class="string">'BackgroundColor'</span>), get(0,<span class="string">'defaultUicontrolBackgroundColor'</span>))
1608     set(hObject,<span class="string">'BackgroundColor'</span>,<span class="string">'white'</span>);
1609 <span class="keyword">end</span>
1610 
1611 
1612 <span class="comment">% --- Executes on button press in saveweight.</span>
1613 <a name="_sub35" href="#_subfunctions" class="code">function saveweight_Callback(hObject, eventdata, handles)</a>
1614 <span class="comment">% hObject    handle to saveweight (see GCBO)</span>
1615 <span class="comment">% eventdata  reserved - to be defined in a future version of MATLAB</span>
1616 <span class="comment">% handles    structure with handles and user data (see GUIDATA)</span>
1617 <span class="comment">% chosen model has ROI values or weights per modality : create the table</span>
1618 
1619 <span class="comment">%If there are weights per region, then save the weightes for different</span>
1620 <span class="comment">%regisons</span>
1621 mim = get(handles.imagemenu,<span class="string">'Value'</span>);
1622 <span class="keyword">if</span> mim==0
1623     mim=1;
1624 <span class="keyword">end</span>
1625 num_roi = handles.num_roi(:,mim);
1626 
1627 disp(<span class="string">'Saving the sorted list of regions to text file.....&gt;&gt;'</span>);
1628 modelname = char(strcat(handles.mnames(get(handles.classmenu,<span class="string">'value'</span>)),<span class="string">'_RegionList.txt'</span>));
1629 path = fileparts(handles.pathdir);
1630 weightname=fullfile(path,modelname);
1631 disp(weightname);
1632 fid=fopen(weightname,<span class="string">'w'</span>);
1633 fprintf(fid,<span class="string">'%23s %20s %20s %23s\r\n'</span>,<span class="string">'&quot;ROI Label&quot;'</span>,<span class="string">'&quot;ROI weight (%)&quot;'</span>,<span class="string">'&quot;ROI size (vox)&quot;'</span>,<span class="string">'&quot;Exp. Ranking&quot;'</span>);
1634 dat = handles.dattable;
1635 dat = dat(handles.sort_roi,:);
1636 <span class="keyword">for</span> i = 1:size(num_roi)
1637     cellvalue= dat(i,:);
1638     fprintf(fid, <span class="string">'%22s %19f %20d %23f\r\n'</span>, cellvalue{:});
1639 <span class="keyword">end</span>
1640 fclose(fid);
1641 disp(<span class="string">'Save Done!'</span>);</pre></div>
<hr><address>Generated on Tue 10-Feb-2015 18:16:33 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>